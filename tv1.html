<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b1e4b">
<title>Hokimlik — Davomat Paneli</title>

<script>
/* ================================================================
   ⚙️  SOZLASH — FAQAT SHU YERDA O'ZGARTIRING
   ================================================================ */
const CFG = {
  SHEET_ID: '1QPJoqOpm6Cihu1GcVkgaPu9AjTQOQ9Wf3G3Pq3ilqv4',

  /* Qatorlar (0-indexed):
     0=1-qator sarlavha, 1=bo'sh, 2=ustun nomlari, 3+ ma'lumot */
  DATA_START_ROW: 3,

  /* Ustun indekslari (0-indexed):
     A=0, B=1, C=2, D=3, E=4, F=5 */
  COL_ID:      0,  // A — ID
  COL_FIO:     1,  // B — F.I.O
  COL_LAVOZIM: 2,  // C — Lavozim
  COL_CARD:    3,  // D — rasmi / card
  COL_KELDI:   4,  // E — Keldi vaqti yoki "-"
  COL_KETDI:   5,  // F — Ketdi vaqti yoki "-" (agar mavjud bo'lsa)

  /* Kelish chegarasi: shu vaqtdan keyin kechikkan hisoblanadi */
  LATE_LIMIT_HOUR:   7,
  LATE_LIMIT_MINUTE: 0,

  /* O'tgan necha kunni tekshirsin (listlarni qidirish) */
  SEARCH_DAYS: 45,

  /* Shu so'zlar list nomida bo'lsa, o'tkazib yuboriladi */
  SKIP_SHEETS: ['shablon', 'template', 'Sheet', 'Varaq'],
};
</script>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 15px; -webkit-text-size-adjust: 100%; scroll-behavior: smooth; }
body {
  font-family: 'Plus Jakarta Sans', system-ui, sans-serif;
  background: #eef3fb;
  color: #1a2744;
  min-height: 100vh;
  overscroll-behavior: none;
}
:root {
  --navy:   #0b1e4b;
  --blue:   #1540a0;
  --mid:    #2563eb;
  --green:  #059669;
  --red:    #dc2626;
  --amber:  #d97706;
  --border: #dde8ff;
  --bg:     #eef3fb;
  --white:  #ffffff;
  --r:      14px;
  --sh:     0 2px 12px rgba(11,30,75,0.09);
}

/* ── APP WRAP ── */
.app { max-width: 480px; margin: 0 auto; padding-bottom: 76px; }

/* ── TOP HEADER ── */
.top-header {
  background: linear-gradient(155deg, #0b1e4b 0%, #1540a0 55%, #2563eb 100%);
  padding: 48px 18px 20px;
  position: relative; overflow: hidden;
}
.top-header::before {
  content:''; position:absolute; top:-70px; right:-50px;
  width:240px; height:240px; border-radius:50%;
  background:rgba(255,255,255,0.05);
}
.th-inner { position:relative; z-index:2; display:flex; align-items:flex-start; justify-content:space-between; }
.th-org { font-size:.65rem; font-weight:700; color:rgba(255,255,255,.55); letter-spacing:.09em; text-transform:uppercase; margin-bottom:3px; }
.th-title { font-family:'Sora',sans-serif; font-size:1.22rem; font-weight:800; color:#fff; line-height:1.2; }
.th-date { font-size:.72rem; font-weight:600; color:rgba(255,255,255,.6); margin-top:5px; }
.th-status { display:flex; align-items:center; gap:6px; margin-top:11px; font-size:.68rem; color:rgba(255,255,255,.5); font-weight:600; position:relative; z-index:2; }
.pulse-dot { width:7px; height:7px; border-radius:50%; background:#4ade80; animation:pulse 2s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.55;transform:scale(.8)} }
.refresh-btn { width:40px; height:40px; border-radius:12px; background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.18); display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; }
.refresh-btn:active { background:rgba(255,255,255,.22); }
.refresh-btn svg { width:18px; height:18px; color:#fff; }
.refresh-btn.spin svg { animation:spinAnim .7s linear infinite; }
@keyframes spinAnim { to{transform:rotate(360deg)} }

/* ── DATE TABS ── */
.date-tabs { background:#fff; border-bottom:1px solid var(--border); padding:0 14px; display:flex; gap:4px; overflow-x:auto; scrollbar-width:none; }
.date-tabs::-webkit-scrollbar { display:none; }
.dtab { flex-shrink:0; padding:11px 13px 9px; font-size:.76rem; font-weight:700; color:#64748b; border-bottom:2.5px solid transparent; cursor:pointer; white-space:nowrap; transition:color .15s; }
.dtab:hover { color:var(--blue); }
.dtab.active { color:var(--blue); border-bottom-color:var(--blue); }

/* ── CONTENT ── */
.content { padding:14px 14px 0; }

/* ── LOADING ── */
.loader { display:flex; flex-direction:column; align-items:center; justify-content:center; padding:64px 20px; gap:14px; }
.spinner { width:42px; height:42px; border:3px solid #dbeafe; border-top-color:var(--blue); border-radius:50%; animation:spinAnim .75s linear infinite; }
.loader-txt { font-size:.82rem; color:#64748b; font-weight:600; }

/* ── ERROR ── */
.error-box { background:#fff7f7; border:1.5px solid #fca5a5; border-radius:var(--r); padding:18px; text-align:center; margin:16px 0; }
.error-box b { display:block; font-size:.88rem; color:var(--red); margin-bottom:8px; }
.error-box p { font-size:.75rem; color:#991b1b; line-height:1.5; margin-bottom:12px; }
.retry-btn { background:var(--red); color:#fff; border:none; border-radius:9px; padding:9px 22px; font-size:.82rem; font-weight:700; cursor:pointer; font-family:inherit; }

/* ── STAT CARDS ── */
.stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:12px; }
.sc { background:var(--white); border:1px solid var(--border); border-radius:var(--r); padding:15px 13px 13px; box-shadow:var(--sh); position:relative; overflow:hidden; }
.sc::after { content:''; position:absolute; bottom:0; left:0; right:0; height:3px; border-radius:0 0 var(--r) var(--r); }
.sc-nv::after { background:linear-gradient(90deg,#0b1e4b,#2563eb); }
.sc-gr::after { background:linear-gradient(90deg,#059669,#34d399); }
.sc-rd::after { background:linear-gradient(90deg,#dc2626,#f87171); }
.sc-am::after { background:linear-gradient(90deg,#d97706,#fbbf24); }
.sc-ico { width:34px; height:34px; border-radius:9px; display:flex; align-items:center; justify-content:center; margin-bottom:9px; }
.sc-ico svg { width:17px; height:17px; }
.sc-lbl { font-size:.64rem; font-weight:800; text-transform:uppercase; letter-spacing:.07em; color:#64748b; margin-bottom:3px; }
.sc-val { font-family:'Sora',sans-serif; font-size:1.9rem; font-weight:800; line-height:1; margin-bottom:3px; }
.sc-sub { font-size:.68rem; color:#94a3b8; font-weight:600; }

/* Wide card */
.sc.wide { grid-column:span 2; display:flex; align-items:center; gap:14px; padding:14px 16px; }
.sc.wide .sc-val { font-size:1.7rem; }
.prog-outer { flex:1; }
.prog-bar { height:9px; background:#dbeafe; border-radius:99px; overflow:hidden; margin:7px 0; }
.prog-fill { height:100%; border-radius:99px; background:linear-gradient(90deg,#1540a0,#3b82f6); transition:width 1s ease; }
.prog-labels { display:flex; justify-content:space-between; font-size:.67rem; color:#94a3b8; font-weight:600; }

/* ── SECTION HEAD ── */
.sec-head { display:flex; align-items:center; justify-content:space-between; margin:16px 0 9px; }
.sec-title { font-family:'Sora',sans-serif; font-size:.86rem; font-weight:800; color:var(--navy); }
.sec-badge { font-size:.68rem; font-weight:700; background:#dbeafe; color:var(--blue); border-radius:99px; padding:3px 10px; border:1px solid #bfdbfe; }

/* ── CHART CARDS ── */
.chart-card { background:var(--white); border:1px solid var(--border); border-radius:var(--r); padding:16px; box-shadow:var(--sh); margin-bottom:12px; }
.chart-wrap { position:relative; }
.chart-wrap.h180 { height:180px; }
.chart-wrap.h160 { height:160px; }
.chart-wrap.h140 { height:140px; }

/* ── DONUT ── */
.donut-grid { display:grid; grid-template-columns:138px 1fr; gap:14px; align-items:center; }
.donut-rel { position:relative; width:120px; height:120px; margin:0 auto; }
.donut-center { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); text-align:center; pointer-events:none; }
.donut-num { font-family:'Sora',sans-serif; font-size:1.5rem; font-weight:800; color:var(--navy); line-height:1; }
.donut-lbl { font-size:.6rem; font-weight:700; color:#94a3b8; text-transform:uppercase; letter-spacing:.05em; }
.leg-item { display:flex; align-items:center; gap:7px; margin-bottom:9px; }
.leg-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.leg-name { font-size:.76rem; font-weight:700; color:#334155; flex:1; }
.leg-val { font-size:.78rem; font-weight:800; color:var(--navy); }

/* ── STAFF CARDS ── */
.staff-card { background:var(--white); border:1px solid var(--border); border-radius:12px; padding:12px 13px; display:flex; align-items:center; gap:12px; margin-bottom:8px; box-shadow:var(--sh); }
.ava { width:40px; height:40px; border-radius:11px; display:flex; align-items:center; justify-content:center; font-family:'Sora',sans-serif; font-size:.95rem; font-weight:800; flex-shrink:0; background:#dbeafe; color:var(--blue); }
.si { flex:1; min-width:0; }
.sn { font-size:.82rem; font-weight:800; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:2px; }
.sp { font-size:.66rem; color:#94a3b8; font-weight:500; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.st { text-align:right; flex-shrink:0; }

/* ── TIME PILLS ── */
.pill { display:inline-flex; align-items:center; justify-content:center; padding:4px 10px; border-radius:99px; font-size:.73rem; font-weight:800; font-family:'Sora',sans-serif; min-width:66px; }
.p-ok   { background:#d1fae5; color:#065f46; border:1px solid #a7f3d0; }
.p-late { background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
.p-abs  { background:#fee2e2; color:#dc2626; border:1px solid #fca5a5; }
.p-none { background:#f1f5f9; color:#475569; border:1px solid #e2e8f0; }
.late-tag { font-size:.6rem; font-weight:700; color:#92400e; background:#fef3c7; border-radius:4px; padding:1px 5px; display:inline-block; margin-top:2px; }

/* ── ABSENT CARDS ── */
.abs-card { background:#fff7f7; border:1.5px solid #fecaca; border-radius:12px; padding:12px 13px; display:flex; align-items:center; gap:11px; margin-bottom:8px; }
.abs-num { width:28px; height:28px; border-radius:8px; background:#fee2e2; color:var(--red); font-size:.74rem; font-weight:800; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
.abs-name { font-size:.82rem; font-weight:800; color:#0f172a; margin-bottom:2px; }
.abs-pos { font-size:.67rem; color:#94a3b8; }

/* ── FULL TABLE ── */
.tbl-wrap { border-radius:var(--r); overflow:hidden; box-shadow:var(--sh); border:1px solid var(--border); margin-bottom:12px; overflow-x:auto; }
.ftable { width:100%; border-collapse:collapse; font-size:.78rem; }
.ftable thead th { background:var(--navy); color:rgba(255,255,255,.75); font-size:.63rem; font-weight:700; text-transform:uppercase; letter-spacing:.06em; padding:10px 11px; text-align:left; white-space:nowrap; }
.ftable tbody td { padding:10px 11px; border-bottom:1px solid #eef2ff; color:#0f172a; font-weight:600; vertical-align:middle; }
.ftable tbody tr:last-child td { border-bottom:none; }
.ftable tbody tr:hover td { background:#f5f8ff; }
.td-id { color:var(--blue); font-weight:800; font-family:'Sora',sans-serif; font-size:.85rem; }
.td-time { font-family:'Sora',sans-serif; font-size:.8rem; font-weight:700; }

/* ── SEARCH ── */
.search-wrap { position:relative; margin-bottom:11px; margin-top:12px; }
.search-inp { width:100%; background:#fff; border:1.5px solid var(--border); border-radius:11px; padding:11px 40px 11px 14px; font-size:.84rem; font-family:inherit; font-weight:600; color:#0f172a; box-shadow:var(--sh); }
.search-inp:focus { outline:none; border-color:var(--mid); box-shadow:0 0 0 3px rgba(37,99,235,.1); }
.search-inp::placeholder { color:#b0bec5; font-weight:500; }
.search-ico { position:absolute; right:13px; top:50%; transform:translateY(-50%); color:#94a3b8; }
.search-ico svg { width:17px; height:17px; }

/* ── XULOSA — SUMMARY PAGE ── */
.xulosa-emp { background:#fff; border:1px solid var(--border); border-radius:var(--r); margin-bottom:10px; box-shadow:var(--sh); overflow:hidden; }
.xe-header { display:flex; align-items:center; gap:11px; padding:13px 14px; cursor:pointer; }
.xe-ava { width:42px; height:42px; border-radius:12px; display:flex; align-items:center; justify-content:center; font-family:'Sora',sans-serif; font-size:.95rem; font-weight:800; flex-shrink:0; }
.xe-info { flex:1; min-width:0; }
.xe-name { font-size:.83rem; font-weight:800; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:2px; }
.xe-pos { font-size:.66rem; color:#94a3b8; }
.xe-stats { display:flex; gap:8px; align-items:center; flex-shrink:0; }
.xe-badge { font-size:.68rem; font-weight:800; padding:4px 9px; border-radius:8px; }
.xb-abs  { background:#fee2e2; color:var(--red); }
.xb-late { background:#fef3c7; color:var(--amber); }
.xe-arrow { color:#94a3b8; transition:transform .2s; }
.xe-arrow.open { transform:rotate(180deg); }
.xe-detail { display:none; padding:0 14px 13px; border-top:1px solid #f1f5f9; }
.xe-detail.open { display:block; }
.day-row { display:flex; align-items:center; gap:9px; padding:7px 0; border-bottom:1px solid #f8faff; font-size:.76rem; }
.day-row:last-child { border-bottom:none; }
.day-date { font-family:'Sora',sans-serif; font-weight:700; color:#64748b; width:70px; flex-shrink:0; }
.day-status { flex:1; }
.day-time { font-family:'Sora',sans-serif; font-weight:700; font-size:.74rem; }

/* ── HEATMAP ── */
.heatmap-card { background:#fff; border:1px solid var(--border); border-radius:var(--r); padding:16px; box-shadow:var(--sh); margin-bottom:12px; }
.hm-grid { display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-top:10px; }
.hm-cell { aspect-ratio:1; border-radius:5px; display:flex; align-items:center; justify-content:center; font-size:.58rem; font-weight:700; }
.hm-lbl { background:transparent !important; color:#94a3b8 !important; font-weight:800; }
.hm-0  { background:#f1f5f9; color:#94a3b8; }
.hm-1  { background:#bfdbfe; color:#1e40af; }
.hm-2  { background:#93c5fd; color:#1e40af; }
.hm-3  { background:#60a5fa; color:#fff; }
.hm-4  { background:#3b82f6; color:#fff; }
.hm-5  { background:#2563eb; color:#fff; }
.hm-6  { background:#1d4ed8; color:#fff; }
.hm-today { box-shadow:0 0 0 2px #f59e0b; }

/* ── MONTH TREND ── */
.trend-card { background:#fff; border:1px solid var(--border); border-radius:var(--r); padding:16px; box-shadow:var(--sh); margin-bottom:12px; }

/* ── BOTTOM NAV ── */
.bot-nav { position:fixed; bottom:0; left:50%; transform:translateX(-50%); width:100%; max-width:480px; background:rgba(255,255,255,.96); backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px); border-top:1px solid var(--border); display:flex; padding:7px 0 11px; z-index:200; box-shadow:0 -4px 20px rgba(11,30,75,.09); }
.nav-btn { flex:1; display:flex; flex-direction:column; align-items:center; gap:3px; cursor:pointer; padding:3px 0; border:none; background:none; color:#94a3b8; font-family:inherit; transition:color .15s; }
.nav-btn.active { color:var(--blue); }
.nav-btn svg { width:22px; height:22px; }
.nav-lbl { font-size:.6rem; font-weight:700; }

/* ── PAGES ── */
.page { display:none; }
.page.active { display:block; }

/* ── EMPTY ── */
.empty { text-align:center; padding:44px 20px; color:#94a3b8; }
.empty svg { width:46px; height:46px; margin:0 auto 11px; display:block; opacity:.3; }
.empty p { font-size:.83rem; font-weight:700; }

/* ── ANIMATE ── */
@keyframes fadeUp { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }
.anim { animation:fadeUp .28s ease both; }
.anim:nth-child(1){animation-delay:.02s} .anim:nth-child(2){animation-delay:.05s}
.anim:nth-child(3){animation-delay:.08s} .anim:nth-child(4){animation-delay:.11s}
.anim:nth-child(5){animation-delay:.14s} .anim:nth-child(6){animation-delay:.17s}
.anim:nth-child(7){animation-delay:.20s} .anim:nth-child(8){animation-delay:.23s}
.anim:nth-child(9){animation-delay:.26s} .anim:nth-child(10){animation-delay:.29s}
</style>
</head>
<body>
<div class="app">

<!-- ── HEADER ── -->
<div class="top-header">
  <div class="th-inner">
    <div>
      <div class="th-org">Tuman hokimligi apparat</div>
      <div class="th-title">Davomat Paneli</div>
      <div class="th-date" id="hdrDate">Yuklanmoqda...</div>
    </div>
    <button class="refresh-btn" id="refreshBtn" onclick="app.refresh()">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2"
          d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0
             0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
      </svg>
    </button>
  </div>
  <div class="th-status">
    <span class="pulse-dot"></span>
    <span id="lastUpdate">Yuklanmoqda...</span>
  </div>
</div>

<!-- ── DATE TABS ── -->
<div class="date-tabs" id="dateTabs"></div>

<!-- ── PAGE: BUGUN ── -->
<div class="page active" id="page-today">
  <div class="content" id="todayContent">
    <div class="loader"><div class="spinner"></div><div class="loader-txt">Ma'lumot yuklanmoqda...</div></div>
  </div>
</div>

<!-- ── PAGE: RO'YXAT ── -->
<div class="page" id="page-list">
  <div class="content">
    <div class="search-wrap">
      <input class="search-inp" id="searchInp" type="text" placeholder="Ism yoki lavozim bo'yicha qidirish..." oninput="app.filterList()">
      <span class="search-ico"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg></span>
    </div>
    <div id="listContent">
      <div class="loader"><div class="spinner"></div><div class="loader-txt">Yuklanmoqda...</div></div>
    </div>
  </div>
</div>

<!-- ── PAGE: OYLIK ── -->
<div class="page" id="page-monthly">
  <div class="content" id="monthlyContent">
    <div class="loader"><div class="spinner"></div><div class="loader-txt">Yuklanmoqda...</div></div>
  </div>
</div>

<!-- ── PAGE: XULOSA ── -->
<div class="page" id="page-xulosa">
  <div class="content" id="xulosaCont">
    <div class="loader"><div class="spinner"></div><div class="loader-txt">Yuklanmoqda...</div></div>
  </div>
</div>

<!-- ── BOTTOM NAV ── -->
<nav class="bot-nav">
  <button class="nav-btn active" id="nav-today" onclick="app.nav('today')">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
    <span class="nav-lbl">Bugun</span>
  </button>
  <button class="nav-btn" id="nav-list" onclick="app.nav('list')">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/></svg>
    <span class="nav-lbl">Ro'yxat</span>
  </button>
  <button class="nav-btn" id="nav-monthly" onclick="app.nav('monthly')">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
    <span class="nav-lbl">Oylik</span>
  </button>
  <button class="nav-btn" id="nav-xulosa" onclick="app.nav('xulosa')">
    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
    <span class="nav-lbl">Xulosa</span>
  </button>
</nav>

</div>

<script>
/* ================================================================
   HELPERS
   ================================================================ */
const MN = ['Yanvar','Fevral','Mart','Aprel','May','Iyun','Iyul','Avgust','Sentabr','Oktabr','Noyabr','Dekabr'];
const DN = ['Yakshanba','Dushanba','Seshanba','Chorshanba','Payshanba','Juma','Shanba'];
const DNS = ['Yak','Dush','Ses','Chor','Pay','Jum','Sha'];

// Parse date from sheet name "DD-MM-YYYY"
function parseSheetDate(name) {
  const m = name.match(/^(\d{1,2})[-.](\d{1,2})[-.](\d{4})$/);
  if (!m) return null;
  const d = new Date(+m[3], +m[2]-1, +m[1]);
  if (isNaN(d)) return null;
  return d;
}

// Format date for display
function fmtDateFull(d) {
  return `${d.getDate()} ${MN[d.getMonth()]} ${d.getFullYear()} — ${DN[d.getDay()]}`;
}

function fmtDateShort(d) {
  return `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}`;
}

function tabLabel(name) {
  const d = parseSheetDate(name);
  if (!d) return name;
  const today = new Date(); today.setHours(0,0,0,0);
  const dt = new Date(d.getFullYear(), d.getMonth(), d.getDate());
  const diff = Math.round((today - dt) / 86400000);
  if (diff === 0) return 'Bugun';
  if (diff === 1) return 'Kecha';
  return fmtDateShort(d);
}

// Parse time "HH:MM" or "HH:MM:SS" → minutes from midnight, null if invalid
function timeMins(raw) {
  if (!raw) return null;
  const s = String(raw).trim();
  if (s === '' || s === '-' || s.toLowerCase() === 'false') return null;
  const m = s.match(/^(\d{1,2}):(\d{2})/);
  if (!m) return null;
  const h = +m[1], mn = +m[2];
  if (h < 0 || h > 23 || mn < 0 || mn > 59) return null;
  return h * 60 + mn;
}

// Is a time value "absent" (-, empty, false, no data)
function isAbsent(raw) {
  return timeMins(raw) === null;
}

// Is the person late
function isLate(raw) {
  const m = timeMins(raw);
  if (m === null) return false;
  const limit = CFG.LATE_LIMIT_HOUR * 60 + CFG.LATE_LIMIT_MINUTE;
  return m > limit;
}

// Minutes late
function minsLate(raw) {
  const m = timeMins(raw);
  if (m === null) return 0;
  const limit = CFG.LATE_LIMIT_HOUR * 60 + CFG.LATE_LIMIT_MINUTE;
  return Math.max(0, m - limit);
}

function fmtTime(raw) {
  const m = timeMins(raw);
  if (m === null) return '—';
  return `${String(Math.floor(m/60)).padStart(2,'0')}:${String(m%60).padStart(2,'0')}`;
}

function initials(fio) {
  if (!fio) return '?';
  const p = String(fio).trim().split(/\s+/);
  return ((p[0]||'')[0]||'') + ((p[1]||'')[0]||'');
}

const AvaColors = [
  ['#dbeafe','#1540a0'],['#d1fae5','#065f46'],['#fef3c7','#92400e'],
  ['#ede9fe','#4c1d95'],['#fce7f3','#9d174d'],['#ecfdf5','#064e3b'],
];
function avaColor(index) { return AvaColors[index % AvaColors.length]; }

/* ================================================================
   CSV PARSER — robust, handles quoted fields and multi-line
   ================================================================ */
function parseCSV(txt) {
  const rows = [];
  let row = [], cur = '', inQ = false;
  const N = txt.length;

  for (let i = 0; i < N; i++) {
    const c = txt[i];
    if (inQ) {
      if (c === '"') {
        if (i+1 < N && txt[i+1] === '"') { cur += '"'; i++; }
        else inQ = false;
      } else { cur += c; }
    } else {
      if      (c === '"')                    { inQ = true; }
      else if (c === ',')                    { row.push(cur); cur = ''; }
      else if (c === '\n' || c === '\r')     {
        if (c === '\r' && i+1 < N && txt[i+1] === '\n') i++;
        row.push(cur); cur = '';
        rows.push(row); row = [];
      } else { cur += c; }
    }
  }
  if (cur !== '' || row.length) { row.push(cur); rows.push(row); }
  return rows;
}

/* ================================================================
   PARSE SHEET ROWS → staff array (preserves sheet order)
   ================================================================ */
function parseRows(csvRows) {
  const staff = [];
  for (let i = CFG.DATA_START_ROW; i < csvRows.length; i++) {
    const r = csvRows[i];
    if (!r) continue;

    const id      = String(r[CFG.COL_ID]      || '').trim();
    const fio     = String(r[CFG.COL_FIO]     || '').trim();
    const lavozim = String(r[CFG.COL_LAVOZIM]  || '').trim();
    const card    = String(r[CFG.COL_CARD]     || '').trim();
    const keldi   = String(r[CFG.COL_KELDI]   !== undefined ? r[CFG.COL_KELDI]  : '').trim();
    const ketdi   = String(r[CFG.COL_KETDI]   !== undefined ? r[CFG.COL_KETDI]  : '').trim();

    // Skip completely empty rows or header-like rows
    if (!fio || fio === '' || fio.toLowerCase() === 'f.i.o' || fio.toLowerCase() === 'fio') continue;
    // Skip if FIO is numeric (data corruption)
    if (/^\d+$/.test(fio)) continue;

    staff.push({ id, fio, lavozim, card, keldiRaw: keldi, ketdiRaw: ketdi });
  }
  return staff;
}

/* ================================================================
   FETCH ONE SHEET as CSV
   ================================================================ */
async function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${CFG.SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}&t=${Date.now()}`;
  const res = await fetch(url, { cache: 'no-cache' });
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();

  // If Google returns an error page or empty/html response, skip
  if (!txt || txt.trim().startsWith('<!') || txt.trim().length < 10) {
    throw new Error('Empty or invalid response');
  }

  const rows  = parseCSV(txt);
  const staff = parseRows(rows);

  // A valid sheet must have at least 2 staff entries
  if (staff.length < 2) throw new Error('Too few rows — not a valid data sheet');

  return staff;
}

/* ================================================================
   DISCOVER SHEETS — try last N days
   Only accept sheets that:
   1. Have date-formatted name (DD-MM-YYYY)
   2. Return valid staff data (≥2 rows)
   3. Not in SKIP_SHEETS list
   ================================================================ */
async function discoverSheets() {
  const today = new Date();
  const candidates = [];

  for (let i = 0; i < CFG.SEARCH_DAYS; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const dd   = String(d.getDate()).padStart(2,'0');
    const mm   = String(d.getMonth()+1).padStart(2,'0');
    const yyyy = d.getFullYear();
    candidates.push(`${dd}-${mm}-${yyyy}`);
  }

  const results = {};
  const valid   = [];

  // Parallel fetch, ignore failures
  await Promise.all(candidates.map(async (name) => {
    try {
      const data = await fetchSheet(name);
      results[name] = data;
      valid.push(name);
    } catch (_) {
      // skip silently — sheet doesn't exist or invalid
    }
  }));

  // Sort by date descending (most recent first)
  valid.sort((a, b) => {
    const da = parseSheetDate(a), db = parseSheetDate(b);
    return (db?.getTime()||0) - (da?.getTime()||0);
  });

  return { sheets: results, names: valid };
}

/* ================================================================
   CHART INSTANCES
   ================================================================ */
const charts = {};
function destroyChart(id) { if (charts[id]) { charts[id].destroy(); delete charts[id]; } }

/* ================================================================
   APP STATE
   ================================================================ */
const STATE = {
  sheets:      {},  // { sheetName: staff[] }
  names:       [],  // sorted sheet names (desc)
  active:      '',  // currently viewed sheet
  page:        'today',
  listCache:   [],
};

/* ================================================================
   MAIN APP OBJECT
   ================================================================ */
const app = {

  /* ── INIT ── */
  async init() {
    document.getElementById('lastUpdate').textContent = 'Yuklanmoqda...';
    document.getElementById('refreshBtn').classList.add('spin');
    try {
      const { sheets, names } = await discoverSheets();

      if (names.length === 0) {
        app.showErr('Hech qanday ma\'lumot topilmadi.',
          'Google Sheets "Jamoyatga ochiq (Share → Anyone with link → Viewer)" bo\'lishi kerak va list nomlari "DD-MM-YYYY" formatida bo\'lishi shart.');
        return;
      }

      STATE.sheets = sheets;
      STATE.names  = names;
      STATE.active = names[0];

      app.buildTabs();
      app.updateHeader();
      app.renderPage();

      const now = new Date();
      document.getElementById('lastUpdate').textContent =
        `Yangilandi: ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`;

    } catch (e) {
      app.showErr('Xatolik yuz berdi', e.message);
    } finally {
      document.getElementById('refreshBtn').classList.remove('spin');
    }
  },

  /* ── REFRESH ── */
  async refresh() {
    document.getElementById('todayContent').innerHTML = '<div class="loader"><div class="spinner"></div><div class="loader-txt">Yangilanmoqda...</div></div>';
    await app.init();
  },

  /* ── ERROR ── */
  showErr(title, detail) {
    const html = `<div class="error-box"><b>⚠️ ${title}</b><p>${detail}</p><button class="retry-btn" onclick="app.init()">Qayta urinish</button></div>`;
    ['todayContent','listContent','monthlyContent','xulosaCont'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.innerHTML = html;
    });
    document.getElementById('lastUpdate').textContent = 'Xatolik';
    document.getElementById('refreshBtn').classList.remove('spin');
  },

  /* ── HEADER UPDATE ── */
  updateHeader() {
    const d = parseSheetDate(STATE.active);
    document.getElementById('hdrDate').textContent = d ? fmtDateFull(d) : STATE.active;
  },

  /* ── BUILD DATE TABS ── */
  buildTabs() {
    const c = document.getElementById('dateTabs');
    c.innerHTML = '';
    STATE.names.slice(0, 14).forEach((name, i) => {
      const t = document.createElement('div');
      t.className = 'dtab' + (name === STATE.active ? ' active' : '');
      t.textContent = tabLabel(name);
      t.onclick = () => app.selectSheet(name);
      c.appendChild(t);
    });
  },

  /* ── SELECT SHEET ── */
  selectSheet(name) {
    STATE.active = name;
    document.querySelectorAll('.dtab').forEach((t, i) => {
      t.classList.toggle('active', STATE.names[i] === name);
    });
    app.updateHeader();
    app.renderPage();
  },

  /* ── NAV ── */
  nav(page) {
    STATE.page = page;
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`page-${page}`)?.classList.add('active');
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(`nav-${page}`)?.classList.add('active');
    app.renderPage();
    window.scrollTo(0, 0);
  },

  /* ── RENDER CURRENT PAGE ── */
  renderPage() {
    const data = STATE.sheets[STATE.active] || [];
    if (STATE.page === 'today')   app.renderToday(data);
    if (STATE.page === 'list')    app.renderList(data);
    if (STATE.page === 'monthly') app.renderMonthly();
    if (STATE.page === 'xulosa')  app.renderXulosa();
  },

  /* ================================================================
     PAGE: BUGUN
     ================================================================ */
  renderToday(data) {
    const el = document.getElementById('todayContent');

    if (!data || data.length === 0) {
      el.innerHTML = `<div class="empty"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"/></svg><p>Bu sana uchun ma'lumot mavjud emas.</p></div>`;
      return;
    }

    const total  = data.length;
    const came   = data.filter(r => !isAbsent(r.keldiRaw));
    const absent = data.filter(r =>  isAbsent(r.keldiRaw));
    const late   = came.filter(r => isLate(r.keldiRaw));
    const onTime = came.filter(r => !isLate(r.keldiRaw));
    const pct    = total > 0 ? Math.round(came.length / total * 100) : 0;

    // Kelish vaqtlari taqsimoti (30 daqiqalik bucket)
    const buckets = {};
    for (let h = 5; h <= 10; h++) {
      buckets[`${String(h).padStart(2,'0')}:00`] = 0;
      buckets[`${String(h).padStart(2,'0')}:30`] = 0;
    }
    came.forEach(r => {
      const m = timeMins(r.keldiRaw);
      if (m === null) return;
      const h = Math.floor(m / 60);
      const half = m % 60 < 30 ? '00' : '30';
      if (h >= 5 && h <= 10) {
        const key = `${String(h).padStart(2,'0')}:${half}`;
        if (key in buckets) buckets[key]++;
      }
    });

    let html = '<div style="margin-top:12px;">';

    // ── STAT CARDS ──
    html += `<div class="stats-grid">
      <div class="sc sc-nv anim">
        <div class="sc-ico" style="background:#dbeafe;"><svg style="color:#1540a0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>
        <div class="sc-lbl">Jami xodim</div>
        <div class="sc-val" style="color:#0b1e4b;">${total}</div>
        <div class="sc-sub">ro'yxatda</div>
      </div>
      <div class="sc sc-gr anim">
        <div class="sc-ico" style="background:#d1fae5;"><svg style="color:#059669" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M5 13l4 4L19 7"/></svg></div>
        <div class="sc-lbl" style="color:#065f46;">Keldi</div>
        <div class="sc-val" style="color:#065f46;">${came.length}</div>
        <div class="sc-sub">${pct}% davomat</div>
      </div>
      <div class="sc sc-rd anim">
        <div class="sc-ico" style="background:#fee2e2;"><svg style="color:#dc2626" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M6 18L18 6M6 6l12 12"/></svg></div>
        <div class="sc-lbl" style="color:#991b1b;">Kelmadi</div>
        <div class="sc-val" style="color:#991b1b;">${absent.length}</div>
        <div class="sc-sub">qayd etilmadi</div>
      </div>
      <div class="sc sc-am anim">
        <div class="sc-ico" style="background:#fef3c7;"><svg style="color:#d97706" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg></div>
        <div class="sc-lbl" style="color:#92400e;">Kechikdi</div>
        <div class="sc-val" style="color:#92400e;">${late.length}</div>
        <div class="sc-sub">07:00 dan keyin</div>
      </div>
      <div class="sc sc-nv wide anim">
        <div>
          <div class="sc-lbl">Davomat</div>
          <div class="sc-val" style="color:#0b1e4b;">${pct}%</div>
        </div>
        <div class="prog-outer">
          <div class="prog-labels"><span style="color:#059669;">${came.length} keldi</span><span style="color:#dc2626;">${absent.length} kelmadi</span></div>
          <div class="prog-bar"><div class="prog-fill" id="progFill" style="width:0%"></div></div>
          <div class="prog-labels"><span>O'z vaqtida: <b style="color:#059669;">${onTime.length}</b></span><span>Kechikdi: <b style="color:#d97706;">${late.length}</b></span></div>
        </div>
      </div>
    </div>`;

    // ── DONUT ──
    html += `<div class="sec-head"><div class="sec-title">Davomat taqsimoti</div></div>
    <div class="chart-card anim">
      <div class="donut-grid">
        <div class="donut-rel"><canvas id="donutC"></canvas>
          <div class="donut-center"><div class="donut-num">${pct}%</div><div class="donut-lbl">Davomat</div></div>
        </div>
        <div>
          <div class="leg-item"><div class="leg-dot" style="background:#059669;"></div><div class="leg-name">O'z vaqtida</div><div class="leg-val">${onTime.length}</div></div>
          <div class="leg-item"><div class="leg-dot" style="background:#d97706;"></div><div class="leg-name">Kechikdi</div><div class="leg-val">${late.length}</div></div>
          <div class="leg-item"><div class="leg-dot" style="background:#dc2626;"></div><div class="leg-name">Kelmadi</div><div class="leg-val">${absent.length}</div></div>
        </div>
      </div>
    </div>`;

    // ── BAR CHART ──
    html += `<div class="sec-head"><div class="sec-title">Kelish vaqtlari</div><span class="sec-badge">30 daqiqalik</span></div>
    <div class="chart-card anim"><div class="chart-wrap h180"><canvas id="barC"></canvas></div></div>`;

    // ── ENG ERTA KELGANLAR ──
    const sorted = [...came].sort((a,b)=>(timeMins(a.keldiRaw)||999)-(timeMins(b.keldiRaw)||999));
    html += `<div class="sec-head"><div class="sec-title">Eng erta kelganlar</div><span class="sec-badge">top ${Math.min(5,sorted.length)}</span></div>`;
    sorted.slice(0,5).forEach((r,i) => {
      const [bg,fg] = avaColor(i);
      const lateFlag = isLate(r.keldiRaw);
      html += `<div class="staff-card anim">
        <div class="ava" style="background:${bg};color:${fg};">${initials(r.fio)}</div>
        <div class="si">
          <div class="sn">${r.fio}</div>
          <div class="sp">${r.lavozim}</div>
          ${lateFlag ? `<span class="late-tag">Kechikdi</span>` : ''}
        </div>
        <div class="st">
          <span class="pill ${lateFlag?'p-late':'p-ok'}">${fmtTime(r.keldiRaw)}</span>
          ${r.ketdiRaw && !isAbsent(r.ketdiRaw) ? `<div style="font-size:.63rem;color:#94a3b8;margin-top:3px;">${fmtTime(r.ketdiRaw)}</div>`:''}
        </div>
      </div>`;
    });

    // ── KECHIKKAN XODIMLAR ──
    if (late.length > 0) {
      html += `<div class="sec-head"><div class="sec-title" style="color:#d97706;">Kechikkan xodimlar</div><span class="sec-badge" style="background:#fef3c7;color:#d97706;border-color:#fde68a;">${late.length} nafar</span></div>`;
      late.forEach(r => {
        const ml = minsLate(r.keldiRaw);
        html += `<div class="staff-card anim">
          <div class="ava" style="background:#fef3c7;color:#d97706;">${initials(r.fio)}</div>
          <div class="si"><div class="sn">${r.fio}</div><div class="sp">${r.lavozim}</div></div>
          <div class="st">
            <span class="pill p-late">${fmtTime(r.keldiRaw)}</span>
            <div class="late-tag" style="margin-top:3px;">+${ml} daqiqa</div>
          </div>
        </div>`;
      });
    }

    // ── KELMAGAN XODIMLAR ──
    if (absent.length > 0) {
      html += `<div class="sec-head"><div class="sec-title" style="color:#dc2626;">Kelmagan xodimlar</div><span class="sec-badge" style="background:#fee2e2;color:#dc2626;border-color:#fca5a5;">${absent.length} nafar</span></div>`;
      absent.forEach((r,i) => {
        html += `<div class="abs-card anim">
          <div class="abs-num">${i+1}</div>
          <div><div class="abs-name">${r.fio}</div><div class="abs-pos">${r.lavozim}</div></div>
          <span class="pill p-abs" style="margin-left:auto;flex-shrink:0;min-width:0;">KELMADI</span>
        </div>`;
      });
    }

    html += '</div>';
    el.innerHTML = html;

    // Animate progress
    setTimeout(() => { const pb = document.getElementById('progFill'); if (pb) pb.style.width = pct+'%'; }, 80);

    // Charts
    app.drawDonut('donutC', onTime.length, late.length, absent.length);
    app.drawBar('barC', buckets);
  },

  /* ================================================================
     PAGE: RO'YXAT — exact sheet order preserved
     ================================================================ */
  renderList(data) {
    STATE.listCache = data || [];
    app.drawList(STATE.listCache);
  },

  filterList() {
    const q = document.getElementById('searchInp').value.toLowerCase().trim();
    if (!q) { app.drawList(STATE.listCache); return; }
    app.drawList(STATE.listCache.filter(r =>
      r.fio.toLowerCase().includes(q) || r.lavozim.toLowerCase().includes(q)
    ));
  },

  drawList(data) {
    const el = document.getElementById('listContent');
    if (!data || data.length === 0) {
      el.innerHTML = `<div class="empty"><svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2M9 5a2 2 0 002 2h2a2 2 0 002-2"/></svg><p>Ma'lumot topilmadi.</p></div>`;
      return;
    }

    const d = parseSheetDate(STATE.active);
    let html = `<div style="font-size:.73rem;color:#64748b;font-weight:700;margin-bottom:8px;">
      ${d ? fmtDateFull(d) : STATE.active} — jami ${data.length} xodim
    </div>`;

    html += `<div class="tbl-wrap"><table class="ftable">
      <thead><tr>
        <th>#</th><th>F.I.O</th><th>Keldi</th><th>Ketdi</th><th>Holat</th>
      </tr></thead><tbody>`;

    // ORDER: exactly as in sheet (no sorting)
    data.forEach((r, i) => {
      const hasCame = !isAbsent(r.keldiRaw);
      const late_   = hasCame && isLate(r.keldiRaw);
      const pillCls = !hasCame ? 'p-abs' : late_ ? 'p-late' : 'p-ok';
      const pillLbl = !hasCame ? 'KELMADI' : late_ ? 'Kechikdi' : 'O\'z vaqtida';
      const timeClr = !hasCame ? '#dc2626' : late_ ? '#d97706' : '#059669';

      html += `<tr>
        <td class="td-id">${r.id || (i+1)}</td>
        <td style="font-weight:700;max-width:130px;word-break:break-word;font-size:.76rem;">${r.fio}</td>
        <td class="td-time" style="color:${timeClr};">${fmtTime(r.keldiRaw)}</td>
        <td class="td-time" style="color:#64748b;">${fmtTime(r.ketdiRaw)}</td>
        <td><span class="pill ${pillCls}" style="min-width:0;font-size:.67rem;padding:3px 8px;">${pillLbl}</span></td>
      </tr>`;
    });

    html += `</tbody></table></div>`;
    el.innerHTML = html;
  },

  /* ================================================================
     PAGE: OYLIK
     ================================================================ */
  renderMonthly() {
    const el = document.getElementById('monthlyContent');
    if (STATE.names.length === 0) {
      el.innerHTML = `<div class="empty"><p>Ma'lumot yo'q.</p></div>`;
      return;
    }

    // Build per-day stats for available sheets (only real data, no invented)
    const dayStats = STATE.names.map(name => {
      const d = parseSheetDate(name);
      const rows = STATE.sheets[name] || [];
      const present = rows.filter(r => !isAbsent(r.keldiRaw)).length;
      const total   = rows.length;
      const late    = rows.filter(r => !isAbsent(r.keldiRaw) && isLate(r.keldiRaw)).length;
      return { name, d, present, total, late, pct: total > 0 ? Math.round(present/total*100) : 0 };
    }).reverse(); // ascending for chart

    const totalDays = dayStats.length;
    const avgPct = totalDays > 0 ? Math.round(dayStats.reduce((s,d)=>s+d.pct,0)/totalDays) : 0;
    const avgPresent = totalDays > 0 ? Math.round(dayStats.reduce((s,d)=>s+d.present,0)/totalDays) : 0;

    let html = `<div style="margin-top:12px;" class="stats-grid">
      <div class="sc sc-nv anim">
        <div class="sc-lbl">Kuzatilgan kun</div>
        <div class="sc-val" style="color:#0b1e4b;">${totalDays}</div>
        <div class="sc-sub">ma'lumot bor</div>
      </div>
      <div class="sc sc-gr anim">
        <div class="sc-lbl">O'rt. davomat</div>
        <div class="sc-val" style="color:#065f46;">${avgPct}%</div>
        <div class="sc-sub">kunlik o'rtacha</div>
      </div>
    </div>`;

    // Trend chart
    html += `<div class="sec-head"><div class="sec-title">Davomat trendi</div><span class="sec-badge">${totalDays} kun</span></div>
    <div class="trend-card anim"><div class="chart-wrap h160"><canvas id="trendC"></canvas></div></div>`;

    // Heatmap
    html += `<div class="sec-head"><div class="sec-title">Davomat xaritasi</div></div>
    <div class="heatmap-card anim">
      <div style="display:flex;gap:4px;font-size:.6rem;color:#94a3b8;font-weight:800;margin-bottom:6px;">
        ${DNS.map(d=>`<div style="flex:1;text-align:center;">${d}</div>`).join('')}
      </div>
      <div class="hm-grid">${app.buildHeatmap()}</div>
      <div style="display:flex;align-items:center;gap:5px;margin-top:10px;font-size:.63rem;color:#64748b;font-weight:600;">
        <span>Kam:</span>
        ${['#f1f5f9','#bfdbfe','#93c5fd','#60a5fa','#3b82f6','#2563eb','#1d4ed8'].map(c=>`<div style="width:14px;height:14px;border-radius:3px;background:${c};flex-shrink:0;"></div>`).join('')}
        <span>Ko'p</span>
      </div>
    </div>`;

    // Daily detail table
    html += `<div class="sec-head"><div class="sec-title">Kunlik jadval</div></div>
    <div class="tbl-wrap anim"><table class="ftable">
      <thead><tr><th>Sana</th><th>Kun</th><th>Keldi</th><th>Kelmadi</th><th>Kechikdi</th><th>%</th></tr></thead>
      <tbody>`;
    [...dayStats].reverse().forEach(s => { // show newest first in table
      const absent = s.total - s.present;
      html += `<tr>
        <td style="font-family:'Sora',sans-serif;font-size:.75rem;color:#64748b;">${s.d ? fmtDateShort(s.d) : s.name}</td>
        <td style="font-size:.72rem;color:#64748b;">${s.d ? DNS[s.d.getDay()] : ''}</td>
        <td><span style="font-weight:800;color:#059669;">${s.present}</span></td>
        <td>${absent>0?`<span style="font-weight:800;color:#dc2626;">${absent}</span>`:`<span style="color:#94a3b8;">0</span>`}</td>
        <td>${s.late>0?`<span style="font-weight:800;color:#d97706;">${s.late}</span>`:`<span style="color:#94a3b8;">0</span>`}</td>
        <td><span style="font-family:'Sora',sans-serif;font-size:.8rem;font-weight:800;color:${s.pct>=80?'#059669':s.pct>=60?'#d97706':'#dc2626'};">${s.pct}%</span></td>
      </tr>`;
    });
    html += `</tbody></table></div>`;

    el.innerHTML = html;
    app.drawTrend('trendC', dayStats);
  },

  buildHeatmap() {
    if (STATE.names.length === 0) return '';
    const sheetMap = {};
    STATE.names.forEach(n => {
      const d = parseSheetDate(n);
      if (d) sheetMap[n] = d;
    });

    const dates = Object.keys(sheetMap);
    if (dates.length === 0) return '';

    const earliest = dates.reduce((a,b) => sheetMap[a]<=sheetMap[b]?a:b);
    const latest   = dates.reduce((a,b) => sheetMap[a]>=sheetMap[b]?a:b);
    const startD   = new Date(sheetMap[earliest]);
    // Go to Monday of that week
    const dow = startD.getDay() === 0 ? 6 : startD.getDay()-1;
    startD.setDate(startD.getDate()-dow);

    const endD = new Date(sheetMap[latest]);
    const today = new Date(); today.setHours(0,0,0,0);

    const cells = [];
    const cur = new Date(startD);
    while (cur <= endD) {
      const dd   = String(cur.getDate()).padStart(2,'0');
      const mm   = String(cur.getMonth()+1).padStart(2,'0');
      const key  = `${dd}-${mm}-${cur.getFullYear()}`;
      const isT  = cur.getTime() === today.getTime();
      const rows = STATE.sheets[key];

      let cls = 'hm-0';
      let tip = `${dd}.${mm}: ma'lumot yo'q`;

      if (rows) {
        const total   = rows.length;
        const present = rows.filter(r=>!isAbsent(r.keldiRaw)).length;
        tip = `${dd}.${mm}: ${present}/${total}`;
        const ratio = total>0 ? present/total : 0;
        if      (ratio >= 0.95) cls = 'hm-6';
        else if (ratio >= 0.85) cls = 'hm-5';
        else if (ratio >= 0.70) cls = 'hm-4';
        else if (ratio >= 0.55) cls = 'hm-3';
        else if (ratio >= 0.40) cls = 'hm-2';
        else if (ratio >  0)    cls = 'hm-1';
        else                    cls = 'hm-0';
      }

      cells.push(`<div class="hm-cell ${cls}${isT?' hm-today':''}" title="${tip}">${cur.getDate()}</div>`);
      cur.setDate(cur.getDate()+1);
    }
    return cells.join('');
  },

  /* ================================================================
     PAGE: XULOSA (YANGI)
     Ko'p kelmagan va ko'p kechikkan xodimlar — oylik tahlil
     ================================================================ */
  renderXulosa() {
    const el = document.getElementById('xulosaCont');
    if (STATE.names.length === 0) {
      el.innerHTML = `<div class="empty"><p>Ma'lumot yo'q.</p></div>`;
      return;
    }

    const totalDays = STATE.names.length;

    // Build per-employee record (preserve sheet order of first sheet)
    // Use the first (latest) sheet as employee registry
    const registry = STATE.sheets[STATE.names[0]] || [];

    const empMap = {};
    registry.forEach(r => {
      if (!r.fio) return;
      empMap[r.fio] = {
        fio:      r.fio,
        id:       r.id,
        lavozim:  r.lavozim,
        absCount: 0,
        lateCount:0,
        lateMins: 0,
        days:     {},  // { sheetName: { keldi, ketdi, absent, late, lateMin } }
      };
    });

    // Scan all sheets — accumulate per employee
    STATE.names.forEach(sheetName => {
      const rows = STATE.sheets[sheetName] || [];
      rows.forEach(r => {
        if (!r.fio || !empMap[r.fio]) return;
        const emp = empMap[r.fio];
        const abs  = isAbsent(r.keldiRaw);
        const late_ = !abs && isLate(r.keldiRaw);
        const ml    = late_ ? minsLate(r.keldiRaw) : 0;

        emp.days[sheetName] = {
          keldi:   r.keldiRaw,
          ketdi:   r.ketdiRaw,
          absent:  abs,
          late:    late_,
          lateMins: ml,
        };
        if (abs)   emp.absCount++;
        if (late_) { emp.lateCount++; emp.lateMins += ml; }
      });
    });

    const empList = Object.values(empMap);

    // Sort by absCount desc for "ko'p kelmagan"
    const byAbsent = [...empList].filter(e=>e.absCount>0)
                                 .sort((a,b)=>b.absCount-a.absCount || b.lateCount-a.lateCount);

    // Sort by lateCount desc for "ko'p kechikkan"
    const byLate   = [...empList].filter(e=>e.lateCount>0)
                                 .sort((a,b)=>b.lateCount-a.lateCount || b.lateMins-a.lateMins);

    // Overall stats
    const totalAbsInst   = empList.reduce((s,e)=>s+e.absCount,0);
    const totalLateInst  = empList.reduce((s,e)=>s+e.lateCount,0);
    const alwaysCame     = empList.filter(e=>e.absCount===0).length;
    const neverLate      = empList.filter(e=>e.lateCount===0 && Object.keys(e.days).length>0).length;

    let html = `<div style="margin-top:12px;">`;

    // ── Summary stats ──
    html += `<div class="stats-grid">
      <div class="sc sc-nv anim">
        <div class="sc-lbl">Kuzatilgan kun</div>
        <div class="sc-val" style="color:#0b1e4b;">${totalDays}</div>
        <div class="sc-sub">jami kun</div>
      </div>
      <div class="sc sc-gr anim">
        <div class="sc-lbl">Doim keldi</div>
        <div class="sc-val" style="color:#065f46;">${alwaysCame}</div>
        <div class="sc-sub">hech kelmagan yo'q</div>
      </div>
      <div class="sc sc-rd anim">
        <div class="sc-lbl">Jami yo'qlik</div>
        <div class="sc-val" style="color:#dc2626;">${totalAbsInst}</div>
        <div class="sc-sub">${totalDays} kun ichida</div>
      </div>
      <div class="sc sc-am anim">
        <div class="sc-lbl">Jami kechikish</div>
        <div class="sc-val" style="color:#d97706;">${totalLateInst}</div>
        <div class="sc-sub">${totalDays} kun ichida</div>
      </div>
    </div>`;

    // ── KO'P KELMAGAN ──
    html += `<div class="sec-head" style="margin-top:6px;">
      <div class="sec-title" style="color:#dc2626;">Ko'p kelmagan xodimlar</div>
      <span class="sec-badge" style="background:#fee2e2;color:#dc2626;border-color:#fca5a5;">${byAbsent.length} nafar</span>
    </div>`;

    if (byAbsent.length === 0) {
      html += `<div style="background:#d1fae5;border-radius:12px;padding:14px;text-align:center;font-size:.82rem;font-weight:700;color:#065f46;margin-bottom:10px;">✅ Barcha xodimlar hamma kuni kelgan!</div>`;
    } else {
      byAbsent.forEach((emp, i) => {
        const [bg,fg] = avaColor(i);
        const absDays = Object.entries(emp.days)
          .filter(([,v])=>v.absent)
          .sort(([a],[b])=>{
            const da=parseSheetDate(a),db=parseSheetDate(b);
            return (db?.getTime()||0)-(da?.getTime()||0);
          });
        const uid = `abs_${i}`;

        html += `<div class="xulosa-emp anim">
          <div class="xe-header" onclick="toggleDetail('${uid}')">
            <div class="xe-ava" style="background:${bg};color:${fg};">${initials(emp.fio)}</div>
            <div class="xe-info">
              <div class="xe-name">${emp.fio}</div>
              <div class="xe-pos">${emp.lavozim}</div>
            </div>
            <div class="xe-stats">
              <span class="xe-badge xb-abs">${emp.absCount} kun kelmadi</span>
              ${emp.lateCount>0?`<span class="xe-badge xb-late">${emp.lateCount} kech</span>`:''}
            </div>
            <svg class="xe-arrow" id="arr_${uid}" style="width:16px;height:16px;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="xe-detail" id="${uid}">
            <div style="font-size:.7rem;font-weight:700;color:#94a3b8;margin-bottom:8px;padding-top:10px;">
              Kelmagan kunlar (${absDays.length} ta):
            </div>
            ${absDays.map(([name]) => {
              const d = parseSheetDate(name);
              return `<div class="day-row">
                <div class="day-date">${d?fmtDateShort(d):name}</div>
                <div class="day-status"><span class="pill p-abs" style="min-width:0;font-size:.67rem;padding:2px 8px;">KELMADI</span></div>
                <div class="day-time" style="color:#94a3b8;">${d?DNS[d.getDay()]:''}</div>
              </div>`;
            }).join('')}
            ${emp.lateCount > 0 ? `
            <div style="font-size:.7rem;font-weight:700;color:#94a3b8;margin-bottom:8px;margin-top:12px;">
              Kechikkan kunlar (${emp.lateCount} ta):
            </div>
            ${Object.entries(emp.days).filter(([,v])=>v.late).sort(([a],[b])=>{
              const da=parseSheetDate(a),db=parseSheetDate(b);
              return (db?.getTime()||0)-(da?.getTime()||0);
            }).map(([name,v]) => {
              const d = parseSheetDate(name);
              return `<div class="day-row">
                <div class="day-date">${d?fmtDateShort(d):name}</div>
                <div class="day-status"><span class="pill p-late" style="min-width:0;font-size:.67rem;padding:2px 8px;">${fmtTime(v.keldi)}</span></div>
                <div class="day-time" style="color:#d97706;">+${v.lateMins}d</div>
              </div>`;
            }).join('')}` : ''}
          </div>
        </div>`;
      });
    }

    // ── KO'P KECHIKKAN ──
    html += `<div class="sec-head" style="margin-top:8px;">
      <div class="sec-title" style="color:#d97706;">Ko'p kechikkan xodimlar</div>
      <span class="sec-badge" style="background:#fef3c7;color:#d97706;border-color:#fde68a;">${byLate.length} nafar</span>
    </div>`;

    if (byLate.length === 0) {
      html += `<div style="background:#d1fae5;border-radius:12px;padding:14px;text-align:center;font-size:.82rem;font-weight:700;color:#065f46;margin-bottom:10px;">✅ Hech kim kechikkan emas!</div>`;
    } else {
      byLate.forEach((emp, i) => {
        const [bg,fg] = avaColor(i+3);
        const lateDays = Object.entries(emp.days)
          .filter(([,v])=>v.late)
          .sort(([a],[b])=>{
            const da=parseSheetDate(a),db=parseSheetDate(b);
            return (db?.getTime()||0)-(da?.getTime()||0);
          });
        const uid = `late_${i}`;
        const avgMin = emp.lateCount>0 ? Math.round(emp.lateMins/emp.lateCount) : 0;

        html += `<div class="xulosa-emp anim">
          <div class="xe-header" onclick="toggleDetail('${uid}')">
            <div class="xe-ava" style="background:${bg};color:${fg};">${initials(emp.fio)}</div>
            <div class="xe-info">
              <div class="xe-name">${emp.fio}</div>
              <div class="xe-pos">${emp.lavozim}</div>
            </div>
            <div class="xe-stats">
              <span class="xe-badge xb-late">${emp.lateCount} marta</span>
              <span style="font-size:.64rem;color:#94a3b8;font-weight:600;">o'rt +${avgMin}d</span>
            </div>
            <svg class="xe-arrow" id="arr_${uid}" style="width:16px;height:16px;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19 9l-7 7-7-7"/>
            </svg>
          </div>
          <div class="xe-detail" id="${uid}">
            <div style="font-size:.7rem;font-weight:700;color:#94a3b8;margin-bottom:8px;padding-top:10px;">
              Kechikkan kunlar (${lateDays.length} ta) — jami +${emp.lateMins} daqiqa:
            </div>
            ${lateDays.map(([name,v]) => {
              const d = parseSheetDate(name);
              return `<div class="day-row">
                <div class="day-date">${d?fmtDateShort(d):name}</div>
                <div class="day-status"><span class="pill p-late" style="min-width:0;font-size:.67rem;padding:2px 8px;">${fmtTime(v.keldi)}</span></div>
                <div class="day-time" style="color:#d97706;">+${v.lateMins} daqiqa</div>
              </div>`;
            }).join('')}
          </div>
        </div>`;
      });
    }

    html += '</div>';
    el.innerHTML = html;
  },

  /* ================================================================
     CHARTS
     ================================================================ */
  drawDonut(canvasId, onTime, late, absent) {
    destroyChart(canvasId);
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    charts[canvasId] = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ["O'z vaqtida", 'Kechikdi', 'Kelmadi'],
        datasets: [{ data:[onTime,late,absent], backgroundColor:['#059669','#d97706','#dc2626'], borderColor:['#fff','#fff','#fff'], borderWidth:3, hoverOffset:5 }]
      },
      options: {
        cutout:'68%', responsive:true, maintainAspectRatio:true,
        plugins: {
          legend:{display:false},
          tooltip: app.tooltipCfg(c=>`  ${c.label}: ${c.raw} nafar`)
        },
        animation:{duration:600,easing:'easeOutQuart'}
      }
    });
  },

  drawBar(canvasId, buckets) {
    destroyChart(canvasId);
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    const labels = Object.keys(buckets);
    const values = Object.values(buckets);
    const lim = CFG.LATE_LIMIT_HOUR*60 + CFG.LATE_LIMIT_MINUTE;
    charts[canvasId] = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets:[{
          data:values,
          backgroundColor: labels.map(l => (timeMins(l+':00')||999)<=lim ? 'rgba(5,150,105,.65)' : 'rgba(217,119,6,.65)'),
          borderColor:     labels.map(l => (timeMins(l+':00')||999)<=lim ? '#059669' : '#d97706'),
          borderWidth:1.5, borderRadius:6, borderSkipped:false
        }]
      },
      options: {
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip: app.tooltipCfg(c=>`  ${c.raw} nafar`) },
        scales:{
          x:{ ticks:{color:'#64748b',font:{size:9,family:'Plus Jakarta Sans',weight:'700'}}, grid:{display:false}, border:{display:false} },
          y:{ beginAtZero:true, ticks:{color:'#64748b',font:{size:10},stepSize:1,precision:0}, grid:{color:'rgba(11,30,75,.04)'}, border:{display:false} }
        },
        animation:{duration:600,easing:'easeOutQuart'}
      }
    });
  },

  drawTrend(canvasId, dayStats) {
    destroyChart(canvasId);
    const ctx = document.getElementById(canvasId);
    if (!ctx) return;
    const labels = dayStats.map(s=>s.d?fmtDateShort(s.d):s.name);
    const values = dayStats.map(s=>s.pct);
    charts[canvasId] = new Chart(ctx, {
      type:'line',
      data:{
        labels,
        datasets:[{
          data:values, borderColor:'#2563eb', backgroundColor:'rgba(37,99,235,.08)',
          borderWidth:2.2, fill:true, tension:0.4,
          pointRadius:3, pointBackgroundColor:'#2563eb', pointBorderColor:'#fff', pointBorderWidth:2
        }]
      },
      options:{
        responsive:true, maintainAspectRatio:false,
        plugins:{ legend:{display:false}, tooltip:app.tooltipCfg(c=>`  ${c.raw}% davomat`) },
        scales:{
          x:{ ticks:{color:'#64748b',font:{size:9,weight:'700'},maxRotation:45}, grid:{display:false}, border:{display:false} },
          y:{ beginAtZero:true, max:100, ticks:{color:'#64748b',font:{size:10},callback:v=>v+'%'}, grid:{color:'rgba(11,30,75,.04)'}, border:{display:false} }
        },
        animation:{duration:600,easing:'easeOutQuart'}
      }
    });
  },

  tooltipCfg(labelFn) {
    return {
      backgroundColor:'#0b1e4b', titleColor:'#93c5fd', bodyColor:'#e2e8f0',
      borderColor:'#1540a0', borderWidth:1, cornerRadius:10, padding:10,
      titleFont:{family:'Plus Jakarta Sans',weight:'700',size:12},
      bodyFont:{family:'Plus Jakarta Sans',weight:'600',size:12},
      callbacks:{label:labelFn}
    };
  },
};

/* ================================================================
   TOGGLE DETAIL (accordion)
   ================================================================ */
function toggleDetail(uid) {
  const panel = document.getElementById(uid);
  const arrow = document.getElementById('arr_'+uid);
  if (!panel) return;
  const open = panel.classList.toggle('open');
  if (arrow) arrow.classList.toggle('open', open);
}

/* ================================================================
   INIT
   ================================================================ */
document.addEventListener('DOMContentLoaded', () => {
  app.init();
  // Auto-refresh every 5 min
  setInterval(() => app.init(), 5 * 60 * 1000);
});
</script>
</body>
</html>
