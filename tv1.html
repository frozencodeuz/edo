<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0b1e4b">
<title>Hokimlik — Davomat Paneli</title>

<!-- ============================================================
     SOZLASH: Google Sheets ID va sahifalar
     ============================================================ -->
<script>
  // ⚠️ FAQAT SHU YERDA O'ZGARTIRING:
  const SHEET_ID = '1QPJoqOpm6Cihu1GcVkgaPu9AjTQOQ9Wf3G3Pq3ilqv4';
  // Google Sheets "Publish to web" JSON API (CSV format)
  // Sheets albatta "Jamoyatga ochiq" bo'lishi kerak (Share → Anyone with link → Viewer)
  // Har bir list nomi shablon asosida (masalan: 14-02-2026, 13-02-2026)
  const DATA_START_ROW = 3; // Ma'lumotlar nechchi qatordan boshlanadi (3 = 4-chi qator, 0-indexed)
  // Ustunlar: A=ID, B=FIO, C=Lavozim, D=card_id, E=Keldi(vaqt), ...
  // Agar "Keldi" ustuni E bo'lsa: COL_KELDI = 4 (0-indexed)
  const COL_ID       = 0; // A
  const COL_FIO      = 1; // B
  const COL_LAVOZIM  = 2; // C
  const COL_CARD     = 3; // D
  const COL_KELDI    = 4; // E — "Keldi" vaqti yoki "-"
  const COL_KETDI    = 5; // F — "Ketdi" vaqti yoki "-" (agar mavjud bo'lsa)
</script>

<!-- Google Fonts -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&family=Sora:wght@400;600;700;800&display=swap" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<style>
/* ============================================================
   RESET & BASE
   ============================================================ */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html {
  font-size: 15px;
  -webkit-text-size-adjust: 100%;
  scroll-behavior: smooth;
}
body {
  font-family: 'Plus Jakarta Sans', 'Segoe UI', system-ui, sans-serif;
  background: #f0f5ff;
  color: #1a2744;
  min-height: 100vh;
  overscroll-behavior: none;
}
:root {
  --navy:    #0b1e4b;
  --blue:    #1540a0;
  --mid:     #2563eb;
  --accent:  #3b82f6;
  --light:   #dbeafe;
  --bg:      #f0f5ff;
  --white:   #ffffff;
  --green:   #059669;
  --greenbg: #d1fae5;
  --red:     #dc2626;
  --redbg:   #fee2e2;
  --amber:   #d97706;
  --amberbg: #fef3c7;
  --text1:   #0f172a;
  --text2:   #334155;
  --text3:   #64748b;
  --border:  #dde8ff;
  --radius:  16px;
  --shadow:  0 4px 20px rgba(11,30,75,0.10);
  --shadow2: 0 2px 10px rgba(11,30,75,0.07);
}

/* ============================================================
   LAYOUT
   ============================================================ */
.app { max-width: 480px; margin: 0 auto; padding: 0 0 80px; }

/* ============================================================
   TOP HEADER — sticky
   ============================================================ */
.top-header {
  background: linear-gradient(160deg, #0b1e4b 0%, #1540a0 60%, #2563eb 100%);
  padding: 52px 20px 24px;
  position: relative;
  overflow: hidden;
}
.top-header::before {
  content: '';
  position: absolute;
  top: -80px; right: -60px;
  width: 260px; height: 260px;
  border-radius: 50%;
  background: rgba(255,255,255,0.05);
}
.top-header::after {
  content: '';
  position: absolute;
  bottom: -50px; left: -30px;
  width: 180px; height: 180px;
  border-radius: 50%;
  background: rgba(255,255,255,0.03);
}
.header-row {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  position: relative; z-index: 2;
}
.header-org {
  font-family: 'Sora', sans-serif;
  font-size: 0.72rem;
  font-weight: 600;
  color: rgba(255,255,255,0.6);
  letter-spacing: 0.08em;
  text-transform: uppercase;
  margin-bottom: 4px;
}
.header-title {
  font-family: 'Sora', sans-serif;
  font-size: 1.28rem;
  font-weight: 800;
  color: #fff;
  line-height: 1.2;
}
.header-date {
  font-size: 0.75rem;
  font-weight: 600;
  color: rgba(255,255,255,0.65);
  margin-top: 6px;
}
.refresh-btn {
  width: 40px; height: 40px;
  border-radius: 12px;
  background: rgba(255,255,255,0.12);
  border: 1px solid rgba(255,255,255,0.18);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
}
.refresh-btn:active { transform: scale(0.92); background: rgba(255,255,255,0.2); }
.refresh-btn svg { width: 18px; height: 18px; color: #fff; transition: transform 0.4s; }
.refresh-btn.spinning svg { transform: rotate(360deg); }

/* Last updated -->
.header-status {
  display: flex; align-items: center; gap: 6px;
  margin-top: 14px;
  font-size: 0.72rem;
  color: rgba(255,255,255,0.55);
  font-weight: 600;
  position: relative; z-index: 2;
}
.status-dot {
  width: 7px; height: 7px; border-radius: 50%;
  background: #4ade80;
  animation: pulse 2s infinite;
}
@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50%       { opacity: 0.6; transform: scale(0.85); }
}

/* ============================================================
   DATE SELECTOR (list tablar)
   ============================================================ */
.date-selector {
  background: var(--white);
  border-bottom: 1px solid var(--border);
  padding: 0 16px;
  display: flex; gap: 6px; overflow-x: auto;
  scrollbar-width: none;
}
.date-selector::-webkit-scrollbar { display: none; }
.date-tab {
  flex-shrink: 0;
  padding: 12px 14px 10px;
  font-size: 0.78rem;
  font-weight: 700;
  color: var(--text3);
  border-bottom: 2.5px solid transparent;
  cursor: pointer;
  transition: all 0.18s;
  white-space: nowrap;
}
.date-tab:hover { color: var(--blue); }
.date-tab.active { color: var(--blue); border-bottom-color: var(--blue); }

/* ============================================================
   CONTENT AREA
   ============================================================ */
.content { padding: 16px 16px 0; }

/* ============================================================
   LOADING STATE
   ============================================================ */
.loading-wrap {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  padding: 60px 20px;
  gap: 16px;
}
.spinner {
  width: 44px; height: 44px;
  border: 3.5px solid var(--light);
  border-top-color: var(--blue);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.loading-txt { font-size: 0.85rem; color: var(--text3); font-weight: 600; }

/* ============================================================
   ERROR STATE
   ============================================================ */
.error-box {
  background: var(--redbg);
  border: 1.5px solid #fca5a5;
  border-radius: 14px;
  padding: 18px;
  text-align: center;
  margin: 20px 0;
}
.error-box p { font-size: 0.85rem; color: var(--red); font-weight: 700; margin-bottom: 8px; }
.error-box small { font-size: 0.75rem; color: #991b1b; display: block; margin-bottom: 12px; line-height: 1.5; }
.retry-btn {
  background: var(--red);
  color: #fff;
  border: none;
  border-radius: 9px;
  padding: 9px 20px;
  font-size: 0.82rem;
  font-weight: 700;
  cursor: pointer;
  font-family: 'Plus Jakarta Sans', sans-serif;
}

/* ============================================================
   STAT CARDS GRID
   ============================================================ */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 14px;
}
.stat-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 16px 14px 14px;
  box-shadow: var(--shadow2);
  border: 1px solid var(--border);
  position: relative;
  overflow: hidden;
  transition: transform 0.15s;
}
.stat-card:active { transform: scale(0.97); }
.stat-card::after {
  content: '';
  position: absolute;
  bottom: 0; left: 0; right: 0;
  height: 3.5px;
  border-radius: 0 0 16px 16px;
}
.sc-navy::after  { background: linear-gradient(90deg, #0b1e4b, #2563eb); }
.sc-green::after { background: linear-gradient(90deg, #059669, #34d399); }
.sc-red::after   { background: linear-gradient(90deg, #dc2626, #f87171); }
.sc-amber::after { background: linear-gradient(90deg, #d97706, #fbbf24); }

.sc-icon {
  width: 36px; height: 36px;
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 10px;
}
.sc-label {
  font-size: 0.68rem;
  font-weight: 800;
  letter-spacing: 0.07em;
  text-transform: uppercase;
  color: var(--text3);
  margin-bottom: 4px;
}
.sc-value {
  font-family: 'Sora', sans-serif;
  font-size: 2rem;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 4px;
}
.sc-sub { font-size: 0.7rem; color: var(--text3); font-weight: 600; }

/* Wide card (spans 2 cols) */
.stat-card.wide { grid-column: span 2; display: flex; align-items: center; gap: 16px; }
.stat-card.wide .sc-value { font-size: 1.6rem; }
.progress-outer {
  flex: 1;
  height: 10px;
  background: var(--light);
  border-radius: 99px;
  overflow: hidden;
  margin-top: 8px;
}
.progress-inner {
  height: 100%;
  border-radius: 99px;
  background: linear-gradient(90deg, #1540a0, #3b82f6);
  transition: width 1s ease;
}

/* ============================================================
   SECTION HEADER
   ============================================================ */
.section-head {
  display: flex; align-items: center; justify-content: space-between;
  margin: 18px 0 10px;
}
.section-title {
  font-family: 'Sora', sans-serif;
  font-size: 0.88rem;
  font-weight: 800;
  color: var(--navy);
}
.section-badge {
  font-size: 0.7rem;
  font-weight: 700;
  background: var(--light);
  color: var(--blue);
  border-radius: 99px;
  padding: 3px 10px;
  border: 1px solid #bfdbfe;
}

/* ============================================================
   DONUT CHART CARD
   ============================================================ */
.donut-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow2);
  border: 1px solid var(--border);
  margin-bottom: 14px;
}
.donut-grid {
  display: grid;
  grid-template-columns: 160px 1fr;
  gap: 16px;
  align-items: center;
}
.donut-wrap { position: relative; width: 140px; height: 140px; margin: 0 auto; }
.donut-center {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  text-align: center;
  pointer-events: none;
}
.donut-center-num {
  font-family: 'Sora', sans-serif;
  font-size: 1.6rem;
  font-weight: 800;
  color: var(--navy);
  line-height: 1;
}
.donut-center-lbl {
  font-size: 0.65rem;
  font-weight: 700;
  color: var(--text3);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}
.donut-legend { display: flex; flex-direction: column; gap: 10px; }
.legend-item { display: flex; align-items: center; gap: 8px; }
.legend-dot { width: 11px; height: 11px; border-radius: 50%; flex-shrink: 0; }
.legend-name { font-size: 0.78rem; font-weight: 700; color: var(--text2); flex: 1; }
.legend-val { font-size: 0.8rem; font-weight: 800; color: var(--navy); }

/* ============================================================
   BAR CHART CARD
   ============================================================ */
.bar-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow2);
  border: 1px solid var(--border);
  margin-bottom: 14px;
}
.chart-canvas-wrap { position: relative; height: 180px; }

/* ============================================================
   TIMELINE CHART (kelish vaqtlari)
   ============================================================ */
.timeline-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow2);
  border: 1px solid var(--border);
  margin-bottom: 14px;
}
.timeline-chart-wrap { position: relative; height: 160px; }

/* ============================================================
   STAFF LIST CARDS
   ============================================================ */
.staff-section { margin-bottom: 14px; }
.staff-card {
  background: var(--white);
  border-radius: 13px;
  padding: 13px 14px;
  box-shadow: var(--shadow2);
  border: 1px solid var(--border);
  display: flex; align-items: center; gap: 13px;
  margin-bottom: 8px;
  transition: transform 0.12s;
}
.staff-card:active { transform: scale(0.98); }
.staff-avatar {
  width: 42px; height: 42px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-family: 'Sora', sans-serif;
  font-size: 1rem;
  font-weight: 800;
  flex-shrink: 0;
  background: var(--light);
  color: var(--blue);
}
.staff-info { flex: 1; min-width: 0; }
.staff-name {
  font-size: 0.83rem;
  font-weight: 800;
  color: var(--text1);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-bottom: 2px;
}
.staff-pos {
  font-size: 0.68rem;
  color: var(--text3);
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.staff-time {
  text-align: right;
  flex-shrink: 0;
}
.time-pill {
  display: inline-flex; align-items: center; justify-content: center;
  padding: 4px 10px;
  border-radius: 99px;
  font-size: 0.75rem;
  font-weight: 800;
  font-family: 'Sora', sans-serif;
  letter-spacing: 0.02em;
  min-width: 68px;
}
.tp-ok    { background: var(--greenbg); color: #065f46; border: 1px solid #a7f3d0; }
.tp-late  { background: var(--amberbg); color: #92400e; border: 1px solid #fde68a; }
.tp-abs   { background: var(--redbg);   color: var(--red); border: 1px solid #fca5a5; }
.tp-none  { background: #f1f5f9; color: #475569; border: 1px solid #e2e8f0; }

.late-badge {
  font-size: 0.62rem;
  font-weight: 700;
  color: #92400e;
  background: var(--amberbg);
  border-radius: 5px;
  padding: 1px 6px;
  margin-top: 3px;
  display: inline-block;
}

/* ============================================================
   MONTHLY HEATMAP
   ============================================================ */
.heatmap-card {
  background: var(--white);
  border-radius: var(--radius);
  padding: 18px;
  box-shadow: var(--shadow2);
  border: 1px solid var(--border);
  margin-bottom: 14px;
}
.heatmap-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
  margin-top: 12px;
}
.hm-cell {
  aspect-ratio: 1;
  border-radius: 6px;
  display: flex; align-items: center; justify-content: center;
  font-size: 0.62rem;
  font-weight: 700;
  color: #fff;
  position: relative;
}
.hm-label { background: transparent !important; color: var(--text3) !important; font-weight: 800; font-size: 0.6rem; }
.hm-empty { background: #f1f5f9; color: var(--text3) !important; }
.hm-0  { background: #f1f5f9; color: var(--text3) !important; }
.hm-1  { background: #bfdbfe; color: #1e40af; }
.hm-2  { background: #93c5fd; color: #1e40af; }
.hm-3  { background: #60a5fa; color: #fff; }
.hm-4  { background: #3b82f6; }
.hm-5  { background: #2563eb; }
.hm-6  { background: #1d4ed8; }
.hm-today { box-shadow: 0 0 0 2px #f59e0b, 0 0 0 4px rgba(245,158,11,0.2); }

/* ============================================================
   TOP ABSENT LIST
   ============================================================ */
.absent-card {
  background: #fff7f7;
  border: 1.5px solid #fca5a5;
  border-radius: 13px;
  padding: 13px 14px;
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 8px;
}
.absent-num {
  width: 28px; height: 28px;
  border-radius: 8px;
  background: var(--redbg);
  color: var(--red);
  font-size: 0.75rem;
  font-weight: 800;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.absent-name { font-size: 0.82rem; font-weight: 800; color: var(--text1); margin-bottom: 2px; }
.absent-days { font-size: 0.7rem; color: var(--red); font-weight: 700; }

/* ============================================================
   BOTTOM NAV
   ============================================================ */
.bottom-nav {
  position: fixed;
  bottom: 0; left: 50%; transform: translateX(-50%);
  width: 100%; max-width: 480px;
  background: rgba(255,255,255,0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex;
  padding: 8px 0 12px;
  z-index: 100;
  box-shadow: 0 -4px 24px rgba(11,30,75,0.08);
}
.nav-item {
  flex: 1;
  display: flex; flex-direction: column;
  align-items: center; gap: 3px;
  cursor: pointer;
  padding: 4px 0;
  transition: all 0.15s;
  color: var(--text3);
  border: none; background: none;
  font-family: 'Plus Jakarta Sans', sans-serif;
}
.nav-item.active { color: var(--blue); }
.nav-item svg { width: 22px; height: 22px; }
.nav-label { font-size: 0.62rem; font-weight: 700; }

/* ============================================================
   PAGE VIEWS
   ============================================================ */
.page { display: none; }
.page.active { display: block; }

/* ============================================================
   DETAIL TABLE (full list)
   ============================================================ */
.detail-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.detail-table th {
  background: var(--navy);
  color: rgba(255,255,255,0.75);
  font-size: 0.65rem;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  padding: 10px 10px;
  text-align: left;
  white-space: nowrap;
}
.detail-table td {
  padding: 10px 10px;
  border-bottom: 1px solid #eef2ff;
  color: var(--text1);
  font-weight: 600;
  vertical-align: middle;
}
.detail-table tr:hover td { background: #f8faff; }
.detail-table tr:last-child td { border-bottom: none; }
.dt-id { color: var(--blue); font-weight: 800; font-family: 'Sora', sans-serif; }
.table-wrap { border-radius: var(--radius); overflow: hidden; box-shadow: var(--shadow2); border: 1px solid var(--border); }

/* ============================================================
   SEARCH BAR
   ============================================================ */
.search-wrap {
  position: relative;
  margin-bottom: 12px;
}
.search-input {
  width: 100%;
  background: var(--white);
  border: 1.5px solid var(--border);
  border-radius: 12px;
  padding: 12px 42px 12px 16px;
  font-size: 0.85rem;
  font-family: 'Plus Jakarta Sans', sans-serif;
  font-weight: 600;
  color: var(--text1);
  transition: border-color 0.18s, box-shadow 0.18s;
  box-shadow: var(--shadow2);
}
.search-input:focus { outline: none; border-color: var(--mid); box-shadow: 0 0 0 3px rgba(37,99,235,0.12); }
.search-icon { position: absolute; right: 14px; top: 50%; transform: translateY(-50%); color: var(--text3); }

/* ============================================================
   MINI TIMELINE LIST
   ============================================================ */
.timeline-list { display: flex; flex-direction: column; gap: 0; }
.tl-item {
  display: flex; align-items: flex-start; gap: 12px;
  padding: 10px 0;
  border-bottom: 1px solid #f1f5f9;
}
.tl-item:last-child { border-bottom: none; }
.tl-dot-wrap { display: flex; flex-direction: column; align-items: center; gap: 2px; flex-shrink: 0; padding-top: 3px; }
.tl-dot { width: 10px; height: 10px; border-radius: 50%; }
.tl-line { width: 2px; background: #e2e8f0; flex: 1; min-height: 20px; }
.tl-body { flex: 1; min-width: 0; }
.tl-time { font-family: 'Sora', sans-serif; font-size: 0.72rem; font-weight: 700; color: var(--text3); }
.tl-name { font-size: 0.82rem; font-weight: 800; color: var(--text1); margin-bottom: 1px; }
.tl-status { font-size: 0.68rem; font-weight: 700; }

/* ============================================================
   EMPTY STATE
   ============================================================ */
.empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--text3);
}
.empty-state svg { width: 48px; height: 48px; margin: 0 auto 12px; display: block; opacity: 0.3; }
.empty-state p { font-size: 0.85rem; font-weight: 700; }

/* ============================================================
   ANIMATIONS
   ============================================================ */
@keyframes fadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}
.fade-in { animation: fadeUp 0.3s ease both; }
.fade-in:nth-child(1) { animation-delay: 0.02s; }
.fade-in:nth-child(2) { animation-delay: 0.06s; }
.fade-in:nth-child(3) { animation-delay: 0.10s; }
.fade-in:nth-child(4) { animation-delay: 0.14s; }
.fade-in:nth-child(5) { animation-delay: 0.18s; }
.fade-in:nth-child(6) { animation-delay: 0.22s; }
.fade-in:nth-child(7) { animation-delay: 0.26s; }
.fade-in:nth-child(8) { animation-delay: 0.30s; }
</style>
</head>
<body>
<div class="app">

  <!-- ============================================================
       TOP HEADER
       ============================================================ -->
  <div class="top-header">
    <div class="header-row">
      <div>
        <div class="header-org">Tuman hokimligi apparat</div>
        <div class="header-title">Davomat Paneli</div>
        <div class="header-date" id="headerDate">Yuklanmoqda...</div>
      </div>
      <button class="refresh-btn" id="refreshBtn" onclick="refreshData()" title="Yangilash">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2"
                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0
                   0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
        </svg>
      </button>
    </div>
    <div class="header-status">
      <span class="status-dot"></span>
      <span id="lastUpdated">Yangilanmoqda...</span>
    </div>
  </div>

  <!-- Date tabs -->
  <div class="date-selector" id="dateSelector"></div>

  <!-- ============================================================
       PAGE: BUGUN (Dashboard)
       ============================================================ -->
  <div class="page active" id="page-today">
    <div class="content">
      <div id="todayContent">
        <div class="loading-wrap">
          <div class="spinner"></div>
          <div class="loading-txt">Google Sheets dan ma'lumot yuklanmoqda...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       PAGE: RO'YXAT (To'liq jadval)
       ============================================================ -->
  <div class="page" id="page-list">
    <div class="content">
      <div class="search-wrap" style="margin-top:12px;">
        <input type="text" class="search-input" id="searchInput"
               placeholder="Xodim ismini qidirish..."
               oninput="filterTable()">
        <span class="search-icon">
          <svg style="width:18px;height:18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
          </svg>
        </span>
      </div>
      <div id="listContent">
        <div class="loading-wrap"><div class="spinner"></div><div class="loading-txt">Yuklanmoqda...</div></div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       PAGE: OYLIK (Monthly view)
       ============================================================ -->
  <div class="page" id="page-monthly">
    <div class="content">
      <div id="monthlyContent">
        <div class="loading-wrap"><div class="spinner"></div><div class="loading-txt">Yuklanmoqda...</div></div>
      </div>
    </div>
  </div>

  <!-- ============================================================
       BOTTOM NAV
       ============================================================ -->
  <nav class="bottom-nav">
    <button class="nav-item active" id="nav-today" onclick="switchPage('today')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3
                 m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
      </svg>
      <span class="nav-label">Bugun</span>
    </button>
    <button class="nav-item" id="nav-list" onclick="switchPage('list')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2
                 M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2
                 m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"/>
      </svg>
      <span class="nav-label">Ro'yxat</span>
    </button>
    <button class="nav-item" id="nav-monthly" onclick="switchPage('monthly')">
      <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12
                 a2 2 0 002 2z"/>
      </svg>
      <span class="nav-label">Oylik</span>
    </button>
  </nav>

</div><!-- /app -->

<!-- ============================================================
     JAVASCRIPT
     ============================================================ -->
<script>
/* ============================================================
   STATE
   ============================================================ */
let allSheetData    = {};  // { sheetName: [ {id, fio, lavozim, keldi, ketdi}, ... ] }
let sheetNames      = [];  // available list names (latest = today, prev = yesterday, etc.)
let activeSheet     = '';
let activePage      = 'today';
let chartInstances  = {};
let monthlyData     = {};  // aggregated for all sheets

/* ============================================================
   UTILS
   ============================================================ */
const dayNamesUZ = ['Yak','Dush','Ses','Chor','Pay','Juma','Shan'];
const monthNamesUZ = ['Yanvar','Fevral','Mart','Aprel','May','Iyun',
                      'Iyul','Avgust','Sentabr','Oktabr','Noyabr','Dekabr'];

function parseDateFromSheetName(name) {
  // e.g. "14-02-2026" or "14.02.2026"
  const m = name.match(/(\d{1,2})[-.](\d{1,2})[-.](\d{4})/);
  if (m) return new Date(parseInt(m[3]), parseInt(m[2])-1, parseInt(m[1]));
  return null;
}

function formatDateFull(d) {
  if (!d) return '';
  return `${d.getDate()} ${monthNamesUZ[d.getMonth()]} ${d.getFullYear()} — ${dayNamesUZ[d.getDay()]}`;
}

function formatDateShort(name) {
  const d = parseDateFromSheetName(name);
  if (!d) return name;
  const today = new Date(); today.setHours(0,0,0,0);
  const dt = new Date(d); dt.setHours(0,0,0,0);
  const diff = (today - dt) / 86400000;
  if (diff === 0) return 'Bugun';
  if (diff === 1) return 'Kecha';
  return `${d.getDate().toString().padStart(2,'0')}.${(d.getMonth()+1).toString().padStart(2,'0')}`;
}

function timeToMin(t) {
  if (!t || t.trim() === '-' || t.trim() === '') return null;
  const clean = t.replace(/[^0-9:]/g,'').trim();
  const parts = clean.split(':');
  if (parts.length < 2) return null;
  const h = parseInt(parts[0]); const m = parseInt(parts[1]);
  if (isNaN(h) || isNaN(m)) return null;
  return h * 60 + m;
}

function isLate(t) {
  const m = timeToMin(t);
  return m !== null && m > 7 * 60; // 07:00
}

function isEarlyLeave(t) {
  const m = timeToMin(t);
  return m !== null && m <= 18 * 60; // before 18:00
}

function initials(fio) {
  if (!fio) return '?';
  const parts = fio.trim().split(' ');
  return (parts[0]?.[0] || '') + (parts[1]?.[0] || '');
}

function now() { return new Date().toLocaleTimeString('uz-UZ', {hour:'2-digit',minute:'2-digit',second:'2-digit'}); }

/* ============================================================
   GOOGLE SHEETS CSV FETCH
   CSV URL format: /gviz/tq?tqx=out:csv&sheet=SHEET_NAME
   ============================================================ */
function sheetUrl(sheetName) {
  return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
}

// Get list of sheet names via gviz JSON
async function fetchSheetNames() {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
  const res = await fetch(url);
  const txt = await res.text();
  // response is: google.visualization.Query.setResponse({...})
  const json = JSON.parse(txt.match(/google\.visualization\.Query\.setResponse\(([\s\S]*)\)/)[1]);
  // This doesn't give sheet names directly — we use a different approach
  return null;
}

// Parse CSV text into rows
function parseCSV(text) {
  const lines = [];
  let cur = '', inQ = false;
  const row = [];

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') {
      if (inQ && text[i+1] === '"') { cur += '"'; i++; }
      else inQ = !inQ;
    } else if (c === ',' && !inQ) {
      row.push(cur.trim()); cur = '';
    } else if ((c === '\n' || c === '\r') && !inQ) {
      if (c === '\r' && text[i+1] === '\n') i++;
      row.push(cur.trim()); cur = '';
      lines.push([...row]); row.length = 0;
    } else {
      cur += c;
    }
  }
  if (cur || row.length) { row.push(cur.trim()); lines.push([...row]); }
  return lines;
}

// Parse sheet rows into staff objects
function parseSheetRows(rows) {
  const staff = [];
  for (let i = DATA_START_ROW; i < rows.length; i++) {
    const r = rows[i];
    if (!r || r.length < 2) continue;
    const id  = (r[COL_ID]  || '').trim();
    const fio = (r[COL_FIO] || '').trim();
    if (!fio || fio === '') continue;
    staff.push({
      id:      id,
      fio:     fio,
      lavozim: (r[COL_LAVOZIM] || '').trim(),
      card:    (r[COL_CARD]    || '').trim(),
      keldi:   (r[COL_KELDI]  !== undefined ? r[COL_KELDI]  : '').trim(),
      ketdi:   (r[COL_KETDI]  !== undefined ? r[COL_KETDI]  : '').trim(),
    });
  }
  return staff;
}

// Fetch one sheet
async function fetchSheet(sheetName) {
  const url = sheetUrl(sheetName);
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const txt = await res.text();
  // CSV dan keldi ustunini topamiz
  const rows = parseCSV(txt);
  return parseSheetRows(rows);
}

/* ============================================================
   DISCOVER SHEETS
   Strategy: try to fetch last 31 sheets by guessing dates
   Also try "shablon" sheet to get structure, skip it.
   We auto-detect sheet names from known date pattern.
   ============================================================ */
async function discoverAndFetch() {
  // Try to get list from GViz metadata
  const metaUrl = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=shablon`;
  // We'll just try to fetch recent dates
  const today = new Date();
  const names = [];

  // Try last 31 days
  for (let i = 0; i < 31; i++) {
    const d = new Date(today);
    d.setDate(d.getDate() - i);
    const dd = d.getDate().toString().padStart(2,'0');
    const mm = (d.getMonth()+1).toString().padStart(2,'0');
    const yyyy = d.getFullYear();
    names.push(`${dd}-${mm}-${yyyy}`);
  }

  const results = {};
  const validNames = [];

  // Fetch all in parallel, ignore failures
  const fetches = names.map(async (name) => {
    try {
      const data = await fetchSheet(name);
      if (data && data.length > 0) {
        results[name] = data;
        validNames.push(name);
      }
    } catch (e) {
      // silently skip
    }
  });

  await Promise.all(fetches);

  // Sort validNames descending (latest first)
  validNames.sort((a, b) => {
    const da = parseDateFromSheetName(a);
    const db = parseDateFromSheetName(b);
    return (db?.getTime() || 0) - (da?.getTime() || 0);
  });

  return { data: results, names: validNames };
}

/* ============================================================
   MAIN LOAD
   ============================================================ */
async function loadData(forceRefresh = false) {
  document.getElementById('lastUpdated').textContent = 'Yuklanmoqda...';
  document.getElementById('refreshBtn').classList.add('spinning');

  try {
    const { data, names } = await discoverAndFetch();

    if (names.length === 0) {
      showError('Ma\'lumot topilmadi. Google Sheet "Jamoyatga ochiq" (Public) qilib qo\'yilganligini tekshiring.');
      return;
    }

    allSheetData = data;
    sheetNames   = names;
    activeSheet  = names[0]; // latest

    // Build monthly aggregate
    buildMonthlyData();

    // Update header date
    const d = parseDateFromSheetName(activeSheet);
    document.getElementById('headerDate').textContent = d ? formatDateFull(d) : activeSheet;

    // Build date tabs
    buildDateTabs();

    // Render active page
    renderAll();

    document.getElementById('lastUpdated').textContent = `Yangilandi: ${now()}`;

  } catch (err) {
    showError(`Xatolik: ${err.message}. Internet aloqasini tekshiring.`);
    console.error(err);
  } finally {
    document.getElementById('refreshBtn').classList.remove('spinning');
  }
}

function showError(msg) {
  document.getElementById('todayContent').innerHTML = `
    <div class="error-box">
      <p>⚠️ Ma'lumot yuklanmadi</p>
      <small>${msg}</small>
      <button class="retry-btn" onclick="loadData(true)">Qayta urinish</button>
    </div>`;
  document.getElementById('lastUpdated').textContent = 'Xatolik yuz berdi';
  document.getElementById('refreshBtn').classList.remove('spinning');
}

/* ============================================================
   BUILD DATE TABS
   ============================================================ */
function buildDateTabs() {
  const container = document.getElementById('dateSelector');
  container.innerHTML = '';
  sheetNames.slice(0, 14).forEach((name, i) => {
    const tab = document.createElement('div');
    tab.className = 'date-tab' + (name === activeSheet ? ' active' : '');
    tab.textContent = formatDateShort(name);
    tab.onclick = () => selectSheet(name);
    container.appendChild(tab);
  });
}

function selectSheet(name) {
  activeSheet = name;
  // Update tab active state
  document.querySelectorAll('.date-tab').forEach((tab, i) => {
    tab.classList.toggle('active', sheetNames[i] === name);
  });
  // Update header date
  const d = parseDateFromSheetName(name);
  document.getElementById('headerDate').textContent = d ? formatDateFull(d) : name;
  renderAll();
}

/* ============================================================
   BUILD MONTHLY AGGREGATE
   ============================================================ */
function buildMonthlyData() {
  // Per-employee: { fio, days: {date: {keldi, ketdi}} }
  const emp = {};

  sheetNames.forEach(sheetName => {
    const rows = allSheetData[sheetName] || [];
    rows.forEach(r => {
      if (!r.fio) return;
      if (!emp[r.fio]) emp[r.fio] = { fio: r.fio, id: r.id, lavozim: r.lavozim, days: {} };
      emp[r.fio].days[sheetName] = { keldi: r.keldi, ketdi: r.ketdi };
    });
  });

  monthlyData = emp;
}

/* ============================================================
   RENDER ALL (current page)
   ============================================================ */
function renderAll() {
  const data = allSheetData[activeSheet] || [];
  if (activePage === 'today')   renderToday(data);
  if (activePage === 'list')    renderList(data);
  if (activePage === 'monthly') renderMonthly();
}

/* ============================================================
   PAGE: BUGUN — DASHBOARD
   ============================================================ */
function renderToday(data) {
  if (!data || data.length === 0) {
    document.getElementById('todayContent').innerHTML = `
      <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"/>
        </svg>
        <p>Bu sana uchun ma'lumot yo'q.</p>
      </div>`;
    return;
  }

  const total   = data.length;
  const came    = data.filter(r => r.keldi && r.keldi !== '-' && r.keldi !== '');
  const absent  = data.filter(r => !r.keldi || r.keldi === '-' || r.keldi === '');
  const late    = came.filter(r => isLate(r.keldi));
  const onTime  = came.filter(r => !isLate(r.keldi));
  const pct     = Math.round(came.length / total * 100);

  // Sort came by time
  const cameSorted = [...came].sort((a, b) => (timeToMin(a.keldi) || 999) - (timeToMin(b.keldi) || 999));

  // Kelish vaqtlari bo'yicha taqsimot (5:00-10:00, 30min buckets)
  const buckets = {};
  for (let h = 5; h <= 10; h++) {
    for (let m = 0; m < 60; m += 30) {
      const key = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
      buckets[key] = 0;
    }
  }
  came.forEach(r => {
    const m = timeToMin(r.keldi);
    if (m === null) return;
    const hh = Math.floor(m / 60);
    const mm = m % 60 < 30 ? 0 : 30;
    if (hh >= 5 && hh <= 10) {
      const key = `${hh.toString().padStart(2,'0')}:${mm.toString().padStart(2,'0')}`;
      if (key in buckets) buckets[key]++;
    }
  });

  let html = '';

  // ---- STAT CARDS ----
  html += `<div style="margin-top:12px;">`;
  html += `<div class="stats-grid">`;

  // Total
  html += `<div class="stat-card sc-navy fade-in">
    <div class="sc-icon" style="background:#dbeafe;">
      <svg style="width:18px;height:18px;color:#1d4ed8;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857
                 M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857
                 m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
      </svg>
    </div>
    <div class="sc-label">Jami xodim</div>
    <div class="sc-value" style="color:#0b1e4b;">${total}</div>
    <div class="sc-sub">ro'yxatda</div>
  </div>`;

  // Keldi
  html += `<div class="stat-card sc-green fade-in">
    <div class="sc-icon" style="background:#d1fae5;">
      <svg style="width:18px;height:18px;color:#059669;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M5 13l4 4L19 7"/>
      </svg>
    </div>
    <div class="sc-label" style="color:#065f46;">Keldi</div>
    <div class="sc-value" style="color:#065f46;">${came.length}</div>
    <div class="sc-sub">${pct}% davomat</div>
  </div>`;

  // Kelmadi
  html += `<div class="stat-card sc-red fade-in">
    <div class="sc-icon" style="background:#fee2e2;">
      <svg style="width:18px;height:18px;color:#dc2626;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.2" d="M6 18L18 6M6 6l12 12"/>
      </svg>
    </div>
    <div class="sc-label" style="color:#991b1b;">Kelmadi</div>
    <div class="sc-value" style="color:#991b1b;">${absent.length}</div>
    <div class="sc-sub">qayd etilmadi</div>
  </div>`;

  // Kechikdi
  html += `<div class="stat-card sc-amber fade-in">
    <div class="sc-icon" style="background:#fef3c7;">
      <svg style="width:18px;height:18px;color:#d97706;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
    </div>
    <div class="sc-label" style="color:#92400e;">Kechikdi</div>
    <div class="sc-value" style="color:#92400e;">${late.length}</div>
    <div class="sc-sub">07:00 dan keyin</div>
  </div>`;

  // Progress wide card
  html += `<div class="stat-card wide sc-navy fade-in" style="padding:16px 18px;">
    <div style="flex-shrink:0;">
      <div class="sc-label">Davomat foizi</div>
      <div class="sc-value" style="color:#0b1e4b;font-size:2.2rem;">${pct}%</div>
    </div>
    <div style="flex:1;">
      <div style="display:flex;justify-content:space-between;font-size:0.7rem;font-weight:700;color:#64748b;margin-bottom:6px;">
        <span style="color:#059669;">${came.length} keldi</span>
        <span style="color:#dc2626;">${absent.length} kelmadi</span>
      </div>
      <div class="progress-outer">
        <div class="progress-inner" id="progressBar" style="width:0%"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:0.68rem;color:#94a3b8;font-weight:600;margin-top:6px;">
        <span>O'z vaqtida: <b style="color:#059669;">${onTime.length}</b></span>
        <span>Kechikdi: <b style="color:#d97706;">${late.length}</b></span>
      </div>
    </div>
  </div>`;

  html += `</div>`; // /stats-grid

  // ---- DONUT CHART ----
  html += `
  <div class="section-head"><div class="section-title">Davomat taqsimoti</div></div>
  <div class="donut-card fade-in">
    <div class="donut-grid">
      <div class="donut-wrap">
        <canvas id="donutChart"></canvas>
        <div class="donut-center">
          <div class="donut-center-num">${pct}%</div>
          <div class="donut-center-lbl">Davomat</div>
        </div>
      </div>
      <div class="donut-legend">
        <div class="legend-item">
          <div class="legend-dot" style="background:#059669;"></div>
          <div class="legend-name">O'z vaqtida</div>
          <div class="legend-val">${onTime.length}</div>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:#d97706;"></div>
          <div class="legend-name">Kechikdi</div>
          <div class="legend-val">${late.length}</div>
        </div>
        <div class="legend-item">
          <div class="legend-dot" style="background:#dc2626;"></div>
          <div class="legend-name">Kelmadi</div>
          <div class="legend-val">${absent.length}</div>
        </div>
      </div>
    </div>
  </div>`;

  // ---- KELISH VAQTLARI BAR CHART ----
  html += `
  <div class="section-head"><div class="section-title">Kelish vaqtlari taqsimoti</div>
  <span class="section-badge">soat bo'yicha</span></div>
  <div class="bar-card fade-in">
    <div class="chart-canvas-wrap">
      <canvas id="timeBarChart"></canvas>
    </div>
  </div>`;

  // ---- BIRINCHI KELGANLAR (top 5) ----
  html += `
  <div class="section-head">
    <div class="section-title">Eng erta kelganlar</div>
    <span class="section-badge">top 5</span>
  </div>`;
  cameSorted.slice(0, 5).forEach((r, i) => {
    const late_  = isLate(r.keldi);
    const pill   = late_ ? 'tp-late' : 'tp-ok';
    const colors = ['#1540a0','#2563eb','#3b82f6','#60a5fa','#93c5fd'];
    html += `
    <div class="staff-card fade-in">
      <div class="staff-avatar" style="background:${colors[i]}1a;color:${colors[i]};">
        ${initials(r.fio)}
      </div>
      <div class="staff-info">
        <div class="staff-name">${r.fio}</div>
        <div class="staff-pos">${r.lavozim || ''}</div>
        ${late_ ? `<span class="late-badge">Kechikdi</span>` : ''}
      </div>
      <div class="staff-time">
        <span class="time-pill ${pill}">${r.keldi}</span>
        ${r.ketdi && r.ketdi !== '-' ? `<div style="font-size:0.67rem;color:#94a3b8;margin-top:3px;text-align:right;">Ketdi: ${r.ketdi}</div>` : ''}
      </div>
    </div>`;
  });

  // ---- KELMAGAN XODIMLAR ----
  if (absent.length > 0) {
    html += `
    <div class="section-head">
      <div class="section-title" style="color:#dc2626;">Kelmagan xodimlar</div>
      <span class="section-badge" style="background:#fee2e2;color:#dc2626;border-color:#fca5a5;">${absent.length} nafar</span>
    </div>`;
    absent.forEach((r, i) => {
      html += `
      <div class="absent-card fade-in">
        <div class="absent-num">${i+1}</div>
        <div>
          <div class="absent-name">${r.fio}</div>
          <div class="absent-days">${r.lavozim || 'Lavozim ko\'rsatilmagan'}</div>
        </div>
        <span class="time-pill tp-abs" style="margin-left:auto;flex-shrink:0;">KELMADI</span>
      </div>`;
    });
  }

  // ---- KECHIKKAN XODIMLAR ----
  if (late.length > 0) {
    html += `
    <div class="section-head">
      <div class="section-title" style="color:#d97706;">Kechikkan xodimlar</div>
      <span class="section-badge" style="background:#fef3c7;color:#d97706;border-color:#fde68a;">${late.length} nafar</span>
    </div>`;
    late.forEach((r) => {
      html += `
      <div class="staff-card fade-in">
        <div class="staff-avatar" style="background:#fef3c7;color:#d97706;">${initials(r.fio)}</div>
        <div class="staff-info">
          <div class="staff-name">${r.fio}</div>
          <div class="staff-pos">${r.lavozim || ''}</div>
        </div>
        <div class="staff-time">
          <span class="time-pill tp-late">${r.keldi}</span>
          <div class="late-badge" style="margin-top:3px;">
            +${Math.max(0, (timeToMin(r.keldi)||0) - 420)} daqiqa kech
          </div>
        </div>
      </div>`;
    });
  }

  html += `</div>`; // /margin-top wrapper
  document.getElementById('todayContent').innerHTML = html;

  // Animate progress bar
  setTimeout(() => {
    const pb = document.getElementById('progressBar');
    if (pb) pb.style.width = pct + '%';
  }, 100);

  // Draw charts
  drawDonut(onTime.length, late.length, absent.length);
  drawTimeBar(buckets);
}

/* ============================================================
   DONUT CHART
   ============================================================ */
function drawDonut(onTime, late, absent) {
  const ctx = document.getElementById('donutChart');
  if (!ctx) return;

  if (chartInstances['donut']) chartInstances['donut'].destroy();

  chartInstances['donut'] = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ["O'z vaqtida", 'Kechikdi', 'Kelmadi'],
      datasets: [{
        data: [onTime, late, absent],
        backgroundColor: ['#059669', '#d97706', '#dc2626'],
        borderColor: ['#fff', '#fff', '#fff'],
        borderWidth: 3,
        hoverOffset: 6,
      }]
    },
    options: {
      cutout: '70%',
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0b1e4b',
          titleColor: '#93c5fd',
          bodyColor: '#e2e8f0',
          borderColor: '#1540a0',
          borderWidth: 1,
          cornerRadius: 10,
          padding: 10,
          titleFont: { family: 'Plus Jakarta Sans', weight: '700', size: 12 },
          bodyFont: { family: 'Plus Jakarta Sans', weight: '600', size: 12 },
          callbacks: {
            label: (ctx) => `  ${ctx.label}: ${ctx.raw} nafar`
          }
        }
      },
      animation: { duration: 700, easing: 'easeOutQuart' },
    }
  });
}

/* ============================================================
   TIME BAR CHART
   ============================================================ */
function drawTimeBar(buckets) {
  const ctx = document.getElementById('timeBarChart');
  if (!ctx) return;

  if (chartInstances['timebar']) chartInstances['timebar'].destroy();

  const labels = Object.keys(buckets);
  const values = Object.values(buckets);

  // Color bars: before 07:00 = green, after = amber/red
  const colors = labels.map(l => {
    const m = timeToMin(l);
    return m !== null && m <= 420 ? 'rgba(5,150,105,0.75)' : 'rgba(217,119,6,0.7)';
  });
  const borderColors = labels.map(l => {
    const m = timeToMin(l);
    return m !== null && m <= 420 ? '#059669' : '#d97706';
  });

  chartInstances['timebar'] = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: borderColors,
        borderWidth: 1.5,
        borderRadius: 7,
        borderSkipped: false,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0b1e4b',
          titleColor: '#93c5fd',
          bodyColor: '#e2e8f0',
          borderColor: '#1540a0',
          borderWidth: 1,
          cornerRadius: 10,
          padding: 10,
          callbacks: { label: c => `  ${c.raw} nafar` }
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', font: { size: 10, family: 'Plus Jakarta Sans', weight: '700' } },
          grid: { display: false },
          border: { display: false },
        },
        y: {
          beginAtZero: true,
          ticks: { color: '#64748b', font: { size: 10 }, stepSize: 1, precision: 0 },
          grid: { color: 'rgba(11,30,75,0.05)' },
          border: { display: false },
        }
      },
      animation: { duration: 600, easing: 'easeOutQuart' }
    }
  });
}

/* ============================================================
   PAGE: RO'YXAT — full table
   ============================================================ */
let listDataCache = [];

function renderList(data) {
  listDataCache = data || [];
  if (listDataCache.length === 0) {
    document.getElementById('listContent').innerHTML = `
      <div class="empty-state">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2"/>
        </svg>
        <p>Ma'lumot yo'q.</p>
      </div>`;
    return;
  }
  renderFilteredTable(listDataCache);
}

function renderFilteredTable(data) {
  let html = `<div class="table-wrap">
    <div style="overflow-x:auto;">
    <table class="detail-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>F.I.O</th>
          <th>Keldi</th>
          <th>Ketdi</th>
          <th>Holat</th>
        </tr>
      </thead>
      <tbody>`;

  data.forEach(r => {
    const hasCame = r.keldi && r.keldi !== '-' && r.keldi !== '';
    const late_   = hasCame && isLate(r.keldi);
    let pill = '';
    if (!hasCame) pill = `<span class="time-pill tp-abs" style="font-size:0.68rem;min-width:0;padding:3px 8px;">KELMADI</span>`;
    else if (late_) pill = `<span class="time-pill tp-late" style="font-size:0.68rem;min-width:0;padding:3px 8px;">Kechikdi</span>`;
    else pill = `<span class="time-pill tp-ok" style="font-size:0.68rem;min-width:0;padding:3px 8px;">O'z vaqtida</span>`;

    html += `<tr>
      <td class="dt-id">${r.id}</td>
      <td style="font-weight:700;max-width:140px;white-space:normal;font-size:0.77rem;">${r.fio}</td>
      <td style="font-family:'Sora',sans-serif;font-size:0.8rem;font-weight:700;color:${hasCame ? (late_ ? '#d97706' : '#059669') : '#dc2626'};">
        ${hasCame ? r.keldi : '—'}
      </td>
      <td style="font-family:'Sora',sans-serif;font-size:0.8rem;color:#64748b;">
        ${r.ketdi && r.ketdi !== '-' ? r.ketdi : '—'}
      </td>
      <td>${pill}</td>
    </tr>`;
  });

  html += `</tbody></table></div></div>`;
  document.getElementById('listContent').innerHTML = html;
}

function filterTable() {
  const q = document.getElementById('searchInput').value.toLowerCase();
  if (!q) { renderFilteredTable(listDataCache); return; }
  const filtered = listDataCache.filter(r => r.fio.toLowerCase().includes(q) || r.lavozim.toLowerCase().includes(q));
  renderFilteredTable(filtered);
}

/* ============================================================
   PAGE: OYLIK — monthly view
   ============================================================ */
function renderMonthly() {
  if (sheetNames.length === 0) {
    document.getElementById('monthlyContent').innerHTML = `<div class="empty-state"><p>Ma'lumot yo'q.</p></div>`;
    return;
  }

  // Last N days sorted desc
  const days    = sheetNames.slice(0, 31);
  const totalEmp = Object.keys(monthlyData).length || 1;

  // Per-day attendance
  const dayStats = days.map(d => {
    const rows = allSheetData[d] || [];
    const present = rows.filter(r => r.keldi && r.keldi !== '-' && r.keldi !== '').length;
    return { name: d, present, total: rows.length || totalEmp };
  }).reverse();

  // Employees with most absences
  const absCounts = {};
  Object.values(monthlyData).forEach(emp => {
    let absent = 0;
    days.forEach(d => {
      const day = emp.days[d];
      if (!day || !day.keldi || day.keldi === '-' || day.keldi === '') absent++;
    });
    absCounts[emp.fio] = { fio: emp.fio, lavozim: emp.lavozim, absent };
  });
  const topAbsent = Object.values(absCounts).sort((a,b) => b.absent - a.absent).slice(0, 5);

  // Average attendance for the month
  const totalDays = days.length;
  const avgPct = totalDays > 0
    ? Math.round(dayStats.reduce((s, d) => s + (d.present / (d.total || 1) * 100), 0) / totalDays)
    : 0;

  let html = '';

  // Summary stat cards
  html += `<div style="margin-top:12px;" class="stats-grid">
    <div class="stat-card sc-navy fade-in">
      <div class="sc-label">Kuzatilgan kun</div>
      <div class="sc-value" style="color:#0b1e4b;">${totalDays}</div>
      <div class="sc-sub">so'nggi kunlar</div>
    </div>
    <div class="stat-card sc-green fade-in">
      <div class="sc-label">O'rt. davomat</div>
      <div class="sc-value" style="color:#065f46;">${avgPct}%</div>
      <div class="sc-sub">oylik o'rtacha</div>
    </div>
  </div>`;

  // Monthly trend bar chart
  html += `
  <div class="section-head"><div class="section-title">Davomat trendi (oylik)</div></div>
  <div class="bar-card fade-in">
    <div class="chart-canvas-wrap" style="height:160px;">
      <canvas id="monthTrendChart"></canvas>
    </div>
  </div>`;

  // Heatmap
  html += `
  <div class="section-head"><div class="section-title">Davomat xaritasi</div></div>
  <div class="heatmap-card fade-in">
    <div class="heatmap-grid">
      ${['Dush','Ses','Chor','Pay','Juma','Shan','Yak'].map(d =>
        `<div class="hm-cell hm-label">${d}</div>`).join('')}
      ${buildHeatmapCells(days, totalEmp)}
    </div>
    <div style="display:flex;align-items:center;gap:8px;margin-top:12px;font-size:0.68rem;color:#64748b;font-weight:600;">
      <span>Kam:</span>
      ${['#f1f5f9','#bfdbfe','#93c5fd','#60a5fa','#3b82f6','#2563eb','#1d4ed8'].map(c =>
        `<div style="width:16px;height:16px;border-radius:4px;background:${c};flex-shrink:0;"></div>`).join('')}
      <span>Ko'p</span>
    </div>
  </div>`;

  // Top absent employees
  html += `
  <div class="section-head">
    <div class="section-title" style="color:#dc2626;">Ko'p kelmagan xodimlar</div>
    <span class="section-badge" style="background:#fee2e2;color:#dc2626;border-color:#fca5a5;">top 5</span>
  </div>`;
  topAbsent.forEach((emp, i) => {
    if (emp.absent === 0) return;
    html += `
    <div class="absent-card fade-in">
      <div class="absent-num">${i+1}</div>
      <div style="flex:1;min-width:0;">
        <div class="absent-name">${emp.fio}</div>
        <div class="absent-days">${emp.lavozim || ''}</div>
      </div>
      <div style="text-align:right;flex-shrink:0;">
        <span class="time-pill tp-abs" style="min-width:0;">${emp.absent} kun</span>
        <div style="font-size:0.65rem;color:#94a3b8;margin-top:3px;">${totalDays} kundan</div>
      </div>
    </div>`;
  });

  document.getElementById('monthlyContent').innerHTML = html;

  // Draw monthly trend chart
  drawMonthTrend(dayStats);
}

function buildHeatmapCells(days, totalEmp) {
  if (days.length === 0) return '';

  // Find the first monday before the earliest date
  const sortedDays = [...days].sort((a, b) => {
    const da = parseDateFromSheetName(a); const db = parseDateFromSheetName(b);
    return (da?.getTime() || 0) - (db?.getTime() || 0);
  });

  const firstDate = parseDateFromSheetName(sortedDays[0]);
  if (!firstDate) return '';

  // Start from Monday of first week
  const startDate = new Date(firstDate);
  const dow = startDate.getDay() === 0 ? 6 : startDate.getDay() - 1; // Mon=0
  startDate.setDate(startDate.getDate() - dow);

  const lastDate = parseDateFromSheetName(sortedDays[sortedDays.length - 1]) || new Date();

  const cells = [];
  const cur = new Date(startDate);
  const today = new Date(); today.setHours(0,0,0,0);

  while (cur <= lastDate) {
    const dd = cur.getDate().toString().padStart(2,'0');
    const mm = (cur.getMonth()+1).toString().padStart(2,'0');
    const yyyy = cur.getFullYear();
    const key = `${dd}-${mm}-${yyyy}`;
    const dayData = allSheetData[key];
    const isToday = cur.getTime() === today.getTime();

    let cls = 'hm-0';
    let title = `${dd}.${mm}`;

    if (dayData) {
      const present = dayData.filter(r => r.keldi && r.keldi !== '-').length;
      const pct = present / (totalEmp || 1);
      if (pct === 0) cls = 'hm-0';
      else if (pct < 0.3) cls = 'hm-1';
      else if (pct < 0.5) cls = 'hm-2';
      else if (pct < 0.65) cls = 'hm-3';
      else if (pct < 0.75) cls = 'hm-4';
      else if (pct < 0.90) cls = 'hm-5';
      else cls = 'hm-6';
      title = `${dd}.${mm}: ${present} nafar`;
    }

    cells.push(`<div class="hm-cell ${cls} ${isToday ? 'hm-today' : ''}" title="${title}">${cur.getDate()}</div>`);
    cur.setDate(cur.getDate() + 1);
  }

  return cells.join('');
}

function drawMonthTrend(dayStats) {
  const ctx = document.getElementById('monthTrendChart');
  if (!ctx) return;
  if (chartInstances['monthTrend']) chartInstances['monthTrend'].destroy();

  const labels = dayStats.map(d => {
    const dt = parseDateFromSheetName(d.name);
    return dt ? `${dt.getDate().toString().padStart(2,'0')}.${(dt.getMonth()+1).toString().padStart(2,'0')}` : d.name;
  });
  const values = dayStats.map(d => Math.round(d.present / (d.total || 1) * 100));

  chartInstances['monthTrend'] = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        data: values,
        borderColor: '#2563eb',
        backgroundColor: 'rgba(37,99,235,0.1)',
        borderWidth: 2.5,
        fill: true,
        tension: 0.4,
        pointRadius: 3,
        pointBackgroundColor: '#2563eb',
        pointBorderColor: '#fff',
        pointBorderWidth: 2,
        pointHoverRadius: 5,
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: '#0b1e4b',
          titleColor: '#93c5fd',
          bodyColor: '#e2e8f0',
          borderColor: '#1540a0',
          borderWidth: 1,
          cornerRadius: 10,
          padding: 10,
          callbacks: { label: c => `  ${c.raw}% davomat` }
        }
      },
      scales: {
        x: {
          ticks: { color: '#64748b', font: { size: 9, family: 'Plus Jakarta Sans', weight: '700' }, maxRotation: 45 },
          grid: { display: false },
          border: { display: false },
        },
        y: {
          beginAtZero: true,
          max: 100,
          ticks: {
            color: '#64748b', font: { size: 10 },
            callback: v => v + '%'
          },
          grid: { color: 'rgba(11,30,75,0.05)' },
          border: { display: false },
        }
      },
      animation: { duration: 700, easing: 'easeOutQuart' }
    }
  });
}

/* ============================================================
   NAVIGATION
   ============================================================ */
function switchPage(page) {
  activePage = page;

  // Pages
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  const el = document.getElementById(`page-${page}`);
  if (el) el.classList.add('active');

  // Nav items
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const nav = document.getElementById(`nav-${page}`);
  if (nav) nav.classList.add('active');

  // Render
  const data = allSheetData[activeSheet] || [];
  if (page === 'today')   renderToday(data);
  if (page === 'list')    renderList(data);
  if (page === 'monthly') renderMonthly();

  window.scrollTo(0, 0);
}

/* ============================================================
   REFRESH
   ============================================================ */
function refreshData() {
  loadData(true);
}

/* ============================================================
   INIT
   ============================================================ */
document.addEventListener('DOMContentLoaded', () => {
  // Set initial date
  const today = new Date();
  document.getElementById('headerDate').textContent =
    `${today.getDate()} ${monthNamesUZ[today.getMonth()]} ${today.getFullYear()} — ${dayNamesUZ[today.getDay()]}`;

  loadData();

  // Auto-refresh every 5 minutes
  setInterval(() => loadData(), 5 * 60 * 1000);
});
</script>
</body>
</html>
